<section xmlns:th="http://www.thymeleaf.org">
<div class="box box-primary">
    <div class="box-header with-border">
		<div class="row">
			<div class="col-md-5">
				<h2><span class="fa  fa-ellipsis-v"></span> <span th:text="'Libro Diario - ' + ${gestion}"></span> </h2>
			</div>
			<div class="col-md-6">
				<form id="formulario" name="formulario" action="../asiento/verLibroDiario" method="post" data-fv-framework="bootstrap" data-fv-icon-valid="glyphicon glyphicon-ok" data-fv-icon-invalid="glyphicon glyphicon-remove" data-fv-icon-validating="glyphicon glyphicon-refresh">
					<div class="box">
						<div class="box-header">
							<strong>Reporte de Libro Diario</strong>
						</div>
						<div class="box-body">
							<div class="row ">
								<div class="col-md-4">
									<div class="form-group">
										<label>F.Inicio</label>
										<input type="text" class="form-control dataFecha" name="fini" data-fv-notempty="true"/>
									</div>
								</div>
								<div class="col-md-4">
									<div class="form-group">
										<label>F.Fin</label>
										<input type="text" class="form-control dataFecha" name="ffin"  data-fv-notempty="true" />
									</div>
								</div>
								<div class="col-md-4">
									<button type="submit" class="btn btn-xs btn-block btn-primary"> <span class="fa fa-print"></span> <br /> Imprimir libro diario</button>
								</div>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
    </div>
    <div class="box-body">
        <div class="row">
        	<div class="col-md-8 padding-bottom-md">
        	<table id="tabla" class="table table-striped table-bordered dt-responsive" cellspacing="0" width="100%">
	            <thead>
	                <tr>
	                    <th class="all">Asiento</th>
	                    <th class="all">Fecha</th>
						<th class="none">Creado por</th>
	                    <th class="desktop">Concepto</th>
	                    <th class="all">Acciones</th>
	                </tr>
	            </thead>
	            <tbody></tbody>
	        </table>
        	</div>
        	<div class="col-md-4 padding-top-md">
        		<table id="tinfo" class="w3-table-all w3-tiny">
        			<thead>
        			<tr>
        				<th class="w3-center" colspan="2">INFORMACI&Oacute;N DEL ASIENTO</th>
        			</tr>
        			</thead>
        			<tbody>
        				<tr>
        				<td> <strong>N&uacute;mero</strong> </td>
        				<td id="xnumero"></td>
        				</tr>
        				<tr>
        				<td> <strong>Fecha</strong> </td>
        				<td id="xfecha"></td>
        				</tr>
        				<tr>
        				<td> <strong>Concepto</strong> </td>
        				<td id="xconcepto"></td>
        				</tr>
        			</tbody>
        		</table>
        		<table id="tdetalles" class="w3-table-all w3-tiny">
        			<thead>
        			<tr>
        				<th colspan="3" class="w3-center"> <strong>DETALLE DEL ASIENTO</strong> </th>
        			</tr>
        			<tr>
        				<th>Detalle</th>
        				<th class="w3-right-align">Debe</th>
        				<th class="w3-right-align">Haber</th>
        			</tr>
        			</thead>
        			<tbody>
        				<tr><td class="w3-center">Sin detalles</td></tr>
        			</tbody>
        		</table>
        	</div>
        </div>
        
    </div>
    <!-- /.box-body -->
</div>
<!-- /.box -->
<script>
    $(document).ready(function() {
    	$(".dataFecha").inputmask("dd/mm/yyyy", {
            "placeholder": "dd/mm/yyyy"
        });
        $('#tabla').DataTable({
            dom: "<'row'<'col-sm-8 text-left-align'f><'col-sm-4'l>><'row'<'col-sm-12'tr>><'row w3-tiny'<'col-sm-5'i><'col-sm-7'p>>",
            buttons: [],
            "ajax": {
                "type": "POST",
                "url": "../asiento/listaLibroDiario",
                "data": function(d) {
                    d.estado = true;
                }
            },
			"columnDefs":[{targets: [4],className:'text-right'}],
            "columns": [{
                "data": "numero"
            }, {
                "data": "xfecha"
            }, {
                "data": "created_by"
			}, {
				"data": "concepto"
            }, {
                "data": "cod_asiento"
            }],
            "createdRow": function(row, data, index) {
            	$('td', row).eq(4).html('<div class="btn-group"><button class="btn btn-success ver"  data-toggle="tooltip" data-placement="top" title="Imprimir"><i class="fa fa-eye"></i> </button></div>');
            },
            "drawCallback": function(settings) {
                $('button[data-toggle="tooltip"]').tooltip({
                    animated: 'fade',
                    placement: 'bottom',
                });

            }
        });
        $('#tabla tbody').on('click', 'tr', function() {
            var obj = $('#tabla').DataTable().row(this).data();
            $('#xnumero').html(obj.numero);
            $('#xfecha').html(obj.xfecha);
            $('#xconcepto').html(obj.concepto);
            $('#tdetalles > tbody').html('');
            $.post('../asiento/obtenerDetalle?cod='+obj.cod_asiento, function(resp){
            	if(resp.status){
            		console.log(resp.data)
            		if(resp.data){
            			let tdebe = 0;
            			let thaber = 0;
            			resp.data.forEach(function(item){
            				let row = $('<tr></tr>');
            				$('<td>'+item.xsubcuenta+'</td>').appendTo(row);
            				$('<td class="w3-right-align">'+item.debe+'</td>').appendTo(row);
            				$('<td class="w3-right-align">'+item.haber+'</td>').appendTo(row);
            				$('#tdetalles > tbody:last').append(row);
            				tdebe += item.debe;
            				thaber += item.haber;
            			});
            			let rowFinal = $('<tr></tr>');
        				$('<td class="w3-right-align"><strong>Total</strong></td>').appendTo(rowFinal);
        				$('<td class="w3-right-align">'+tdebe+'</td>').appendTo(rowFinal);
        				$('<td class="w3-right-align">'+thaber+'</td>').appendTo(rowFinal);
        				$('#tdetalles > tbody:last').append(rowFinal);
            		}else{
            			let rowFinal = $('<tr></tr>');
        				$('<td colspan="3" class="w3-center">Sin detalles</td>').appendTo(row);
        				$('#tdetalles > tbody:last').append(rowFinal);
            		}
            		mostrarMensaje('info', resp.msg);
            	}else{
            		let rowFinal = $('<tr></tr>');
    				$('<td colspan="3" class="w3-center">Sin detalles</td>').appendTo(row);
    				$('#tdetalles > tbody:last').append(rowFinal);
            		modalAlert('Error al obtener asiento',resp.msg,'error');
            	}
            });
        });
        $('#formulario').formValidation({
            locale: 'es_ES'
        }).on('success.form.fv', function(e) {
            e.preventDefault();
            var xform = $(e.target);
            $("#frameReportes").attr("src",xform.attr('action')+'?'+ xform.serialize());
            $("#reportes").modal('show');
            $('#formulario')[0].reset();
            xform.data('formValidation').resetForm();
        });
    });
</script>
</section>