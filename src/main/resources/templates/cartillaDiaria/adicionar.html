<section xmlns:th="http://www.thymeleaf.org">
        <div id="modalProducto" class="modal fade" data-backdrop="static">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="nombreTipo">Seleccionar</h4>
                    </div>
                    <div class="modal-body">
                        <table id="tablaProducto" class="table table-striped table-bordered dt-responsive" cellspacing="0" width="100%">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Precio</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
<div class="box box-primary">
    <div class="box-header with-border">
        <div class="row">
            <div class="col-md-8">
                <h1><span class="fa  fa-ellipsis-v"></span> Cartilla del Dia: <strong id="fechaActual"></strong></h1>
            </div>
        </div>
    </div>
    <div class="box-body">
        <div class="row">
            <div class="col-md-5">
                <form id="formulario" class="" method="post" action="../cartillaSucursal/guardar" data-fv-framework="bootstrap" data-fv-excluded="disabled" data-fv-icon-valid="glyphicon glyphicon-ok" data-fv-icon-invalid="glyphicon glyphicon-remove" data-fv-icon-validating="glyphicon glyphicon-refresh">
                <div class="form-group row">
                    <label class="col-md-3">
                        Categoria de platos
                    </label>
                    <div class="col-md-9">
                        <select name="categoriaId" class="select-chosen" id="categoriaId"></select>
                    </div>
                </div>
                <hr>
                <div id="detalles"></div>
                    <div id="areaFooter">
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-danger btn-block" type="button" id="btnDelDet">Eliminar Opcion</button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-success btn-block" type="button" id="btnAddDet">Adicionar Detalle</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="col-md-7">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h5>Detalle de la Cartilla</h5>
                    </div>
                    <div class="box-body">
                        <table class="w3-table-all">
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="box-footer pull-right">
        <button type="button" class="btn btn-social btn-google" data-dismiss="modal" id="btnCancelar"><i class="glyphicon glyphicon-remove-sign"></i> Cancelar</button>
        <button type="submit" class="btn btn-social btn-bitbucket"><i class="glyphicon glyphicon-floppy-disk"></i> Guardar</button>
    </div>
</div>

<script type="text/javascript" th:inline="none">
    var dataReq = {
        tipoProductoSelected:0,
        catalogo: [],
        catalogoSelected:{},
        indexSelected:0,
        detalleCartillaDiaria:[]
    }
    function init(){
        let diaHoy = moment().format('LLL');
        $('#fechaActual').html(diaHoy.substring(0,diaHoy.length-4));
        $.post('../cartillaSucursal/listarPorSucursal', function(resp){
            if(resp.status) {
                dataReq.catalogo = resp.data;
                let options = '<option value="">Seleccionar</option>';
                resp.data.forEach( it=>{
                    options += '<option value="'+it.id+'">'+it.nombre+' - '+it.total+'</option>';
                });
                $('#categoriaId').html(options);
                $('#categoriaId').trigger('chosen:updated');
            }
        })
    }
    $(document).ready(function() {
        $('#btnCancelar').click(function(){
            $.post('../cartillaDiaria/gestion',function(resp){
                $('#contenedor').html(resp);
            })
        });
        $('#btnAddDet').click(function(){
            let formData = $('#formulario').formToJSON();
            console.log(formData);
            for (let i=1; i <= dataReq.catalogoSelected.length; i++) {
                detalleCartillaDiaria.push({
                    productoId: formData['productoId_'+i],
                    precioIndividual:1,
                    precioCompuesto:1,
                    cartillaSucursalId:1,
                    detalleCartillaSucursalId:1,
                    cantidad:1
                });
            }


        })
        $('.select-chosen').chosen({
            no_results_text: "No se encuentra:",
            width: '100%'
        });
        $('#categoriaId').chosen().change(function(){
            let idSelected = $(this).val();
            if(idSelected) {
                $('#detalles').html('');
                idSelected = parseInt(idSelected);
                let categoriaSelected = dataReq.catalogo.find(it => it.id === idSelected);
                dataReq.catalogoSelected = categoriaSelected;
                if(categoriaSelected) {
                    categoriaSelected.detalles.forEach((det,ind) => {
                        let index = ind+1
                        let boxDiv = $('<div class="box box-primary" id="detalleCartillaSucursal"></div>');
                        let boxHeader = $('<div class="box-header with-border"></div>');
                        $('<h5><span class="fa fa-ellipsis-v"></span> '+ det.xtipoProducto +'</h5>').appendTo(boxHeader);
                        boxDiv.append(boxHeader);
                        let boxBody =$('<div class="box-body"></div>');
                        let input1 = $('<div class="form-group"></div>');
                        $('<input type="hidden" id="productoId-'+index+'" name="productoId_'+index+'" value=""/>').appendTo(input1);
                        $('<a href="#" class="form-control selectProduct" id="selectProduct_'+index+'" data-tipoProductoId="'+det.tipoProductoId+'" data-index="'+index+'" >Seleccionar Producto</a>').appendTo(input1);
                        boxBody.append(input1);
                        let row = $('<div class="row"></div>');
                        let col = $('<div class="col-md-4"></div>');
                        input1 = $('<div class="form-group"></div>');
                        $('<label class="control-label">Precio Individual</label>').appendTo(input1);
                        $('<input type="text" class="form-control input-sm" id="pindividual_'+index+'" name="pindividual_'+index+'"/>').appendTo(input1);
                        col.append(input1);
                        row.append(col);
                        col = $('<div class="col-md-4"></div>');
                        input1 = $('<div class="form-group"></div>');
                        $('<label class="control-label">Precio Compuesto</label>').appendTo(input1);
                        $('<input type="text" class="form-control input-sm" id="pcompuesto_'+index+'" name="pcompuesto_'+index+'" value="'+det.precio+'"/>').appendTo(input1);
                        col.append(input1);
                        row.append(col);
                        col = $('<div class="col-md-4"></div>');
                        input1 = $('<div class="form-group"></div>');
                        $('<label class="control-label">Cantidad</label>').appendTo(input1);
                        $('<input type="text" class="form-control input-sm" id="cantidad_'+index+'" name="cantidad_'+index+'" value="1"/>').appendTo(input1);
                        col.append(input1);
                        row.append(col);
                        boxBody.append(row);
                        boxDiv.append(boxBody);
                        $('#detalles').append(boxDiv);
                    });
                    $('.selectProduct').off();
                    $('.selectProduct').on('click',function(){
                        let tipoProductoId = parseInt($(this).data('tipoproductoid'));
                        let index = parseInt($(this).data('index'));
                        dataReq.indexSelected = index;
                        dataReq.tipoProductoSelected = tipoProductoId;
                        $('#tablaProducto').dataTable().fnDraw();
                        $('#modalProducto').modal('show');
                    });
                }
            }
        })
        $('#tablaProducto').DataTable({
            buttons: [],
            "ajax": {
                "type": "POST",
                "url": "../producto/listarPorTipoProducto",
                "data": function(d) {
                    d.estado = true;
                    d.tipo = dataReq.tipoProductoSelected;
                }
            },
            "columnDefs":[{targets: [2],className:'text-right'}],
            "ordering":true,
            "order":[[0,'desc']],
            "columns": [{
                "data": "id", "name":"id"
            }, {
                "data": "nombre", "name":"nombre"
            }, {
                "data": "pvUnit", "name":"pv_unit"
            }],
            "createdRow": function(row, data, index) {},
            "drawCallback": function(settings) {},
            "initComplete": function(settings, json){
                $('#tablaProducto_filter input').unbind();
                $('#tablaProducto_filter input').bind('keyup', function(e) {
                    if(e.keyCode == 13) {
                        $('#tablaProducto').DataTable().search(this.value).draw();
                    }
                })
            }
        });
        $('#tablaProducto tbody').on('click', 'tr', function() {
            let obj = $('#tablaProducto').DataTable().row(this).data();
            $('#selectProduct_'+dataReq.indexSelected).html(obj.nombre);
            $('#pindividual_'+dataReq.indexSelected).val(obj.pvUnit);
            // $('#pcompuesto-'+dataReq.indexSelected).val(obj.nombre);
            // $('#cantidad-'+dataReq.indexSelected).val(obj.nombre);
            dataReq.indexSelected = -1;
            dataReq.tipoProductoSelected = -1;
            $('#modalProducto').modal('hide');
        });
        $('#formulario').formValidation({
            locale: 'es_ES'
        }).on('success.form.fv', function(e) {
            e.preventDefault();
            alertAdicion('Confirmar transaccion', 'Esta seguro de realizar la transaccion?',function(){
            	var xform = $(e.target);
                $.post(xform.attr('action'), xform.serialize(), function(result) {
                    finishTransaction(result, function(){
                        xform.data('formValidation').resetForm();
                        $('.modal').modal('hide');

                    });
                }, 'json');
            });
        });
        init();
    });
</script>
</section>