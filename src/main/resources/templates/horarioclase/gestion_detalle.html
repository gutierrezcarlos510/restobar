<!-- Default box -->
<div class="box box-primary">
    <div class="box-header with-border">
        <form id="formulario" method="post" action="../horarioclase/guardarDetalle?cod_horcla=$horario.cod_horcla" data-fv-framework="bootstrap" data-fv-excluded="disabled" data-fv-icon-valid="glyphicon glyphicon-ok" data-fv-icon-invalid="glyphicon glyphicon-remove"
            data-fv-icon-validating="glyphicon glyphicon-refresh">
            <div id="modalAdicionar" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title">Adicionar Reserva</h4>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Reserva por</label>
                                <select id="cod_per" name="cod_per" class="form-control select-chosen" data-placeholder="Seleccionar..." data-fv-notempty="true">
                      	<option value=""></option>
                      	#foreach($p in $personas)
                      		<option value="$p.cod_est">$p.nom_per $p.priape_per $!{p.segape_per}</option>
                      	#end
                      </select>
                            </div>
                            <div class="form-group">
                                <label>Tipo de Reserva</label>
                                <select id="pri_dethorcla" name="pri_dethorcla" class="form-control select-chosen" data-placeholder="Seleccionar..." data-fv-notempty="true">
                      	<option value=""></option>
                      	<option value="1">Mensual</option>
                      	<option value="2">Clase por hora</option>
                      	<option value="4">Clase Virtual</option>
                      	<option value="3">Practicos</option>
                      	
                      </select>
                            </div>
                            <div class="form-group">
                                <label>Tema</label>
                                <textarea class="form-control" id="tem_dethorcla" name="tem_dethorcla" rows="5" data-fv-notempty="true"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Hora</label>
                                        <input type="text" id="horini" name="horini" class="form-control input-md horas" data-fv-notempty="true">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Hora</label>
                                        <input type="text" id="horfin" name="horfin" class="form-control input-md horas" data-fv-notempty="true">
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-social btn-google" data-dismiss="modal"><i class="glyphicon glyphicon-remove-sign"></i> Cancelar</button>
                            <button type="submit" id="btnAdicionarConfirmacion" class="btn btn-social btn-bitbucket"><i class="glyphicon glyphicon-floppy-disk"></i> Guardar</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
        </form>
        <form id="formularioModificar" method="post" action="../horarioclase/modificarDetalle?cod_horcla=$horario.cod_horcla" data-fv-framework="bootstrap" data-fv-excluded="disabled" data-fv-icon-valid="glyphicon glyphicon-ok" data-fv-icon-invalid="glyphicon glyphicon-remove"
            data-fv-icon-validating="glyphicon glyphicon-refresh">
            <div id="modalModificar" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title">Modificar Reserva</h4>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Reserva por</label>
                                <input type="hidden" id="cod_dethorcla" name="cod_dethorcla">
                                <select id="cod_per1" name="cod_per" class="form-control select-chosen" data-placeholder="Seleccionar..." data-fv-notempty="true">
                      	<option value=""></option>
                      	#foreach($p in $personas)
                      		<option value="$p.cod_est">$p.nom_per $p.priape_per $!{p.segape_per}</option>
                      	#end
                      </select>
                            </div>
                            <div class="form-group">
                                <label>Tipo de Reserva</label>
                                <select id="pri_dethorcla1" name="pri_dethorcla" class="form-control select-chosen" data-placeholder="Seleccionar..." data-fv-notempty="true">
                      	<option value=""></option>
                      	<option value="1">Mensual</option>
                      	<option value="2">Clase por hora</option>
                      	<option value="4">Clase Virtual</option>
                      	<option value="3">Practicos</option>
                      	
                      </select>
                            </div>
                            <div class="form-group">
                                <label>Tema</label>
                                <textarea class="form-control" id="tem_dethorcla1" rows="5" name="tem_dethorcla" data-fv-notempty="true"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Hora</label>
                                        <input type="text" id="horini1" name="horini" class="form-control input-md horas" data-fv-notempty="true">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Hora</label>
                                        <input type="text" id="horfin1" name="horfin" class="form-control input-md horas" data-fv-notempty="true">
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-social btn-google" data-dismiss="modal"><i class="glyphicon glyphicon-remove-sign"></i> Cancelar</button>
                            <button type="submit" id="btnModificarConfirmacion" class="btn btn-social btn-bitbucket"><i class="glyphicon glyphicon-floppy-disk"></i> Guardar</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
        </form>
      
        <div class="box-tools pull-right">
            <button class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip" title="Collapse"><i class="fa fa-minus"></i></button>
            <button class="btn btn-box-tool" data-widget="remove" data-toggle="tooltip" title="Remove"><i class="fa fa-times"></i></button>
        </div>
    </div>
    <div class="box-body">
        <div class="row">
            <div class="col-md-3">
                <h1><span class="fa  fa-ellipsis-v"></span> Gestion Reservas</h1>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger" id="btnVolver"><i class="fa fa-reply-all"></i> Volver a Horarios</button>
            </div>
            <div class="col-md-7">
                <div class="btn-group">
                    <button type="button" class="btn btn-success pull-right" id="btnAdicionar"><i class="glyphicon glyphicon-plus-sign"></i> Adicionar Reserva</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="info-box bg-green">
                    <span class="info-box-icon"><i class="ion ion-person-stalker"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Ayudante</span>
                        <span class="info-box-number">$horario.ayudante</span>
                    </div>
                    <!-- /.info-box-content -->
                </div>
                <!-- /.info-box -->
            </div>
            <div class="col-md-3">
                <div class="info-box bg-green">
                    <span class="info-box-icon"><i class="ion ion-android-time"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Fecha</span>
                        <span class="info-box-number">$horario.fecha</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-box bg-green">
                    <span class="info-box-icon"><i class="ion ion-flash-off"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Materias</span>
                        <span class="info-box-number">$materias</span>
                    </div>
                </div>
            </div>
        </div>
        <table id="tabla" class="table table-striped table-bordered" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Reserva Por</th>
                    <th>Tema</th>
                    <th>Hora Inicio</th>
                    <th>Hora Fin</th>
                    <th>Accion</th>
                </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>
    <!-- /.box-body -->
</div>
<!-- /.box -->
<script>
    $(document).ready(function() {
        $('.select-chosen').chosen({
            no_results_text: "No se encuentra:",
            width: '100%'
        });
        $(".horas").inputmask("hh:mm", {
            "placeholder": "hh:mm"
        });
        $('#pri_dethorcla').chosen().change(function() {
            switch (parseInt($(this).val())) {
                case 1:
                    $('#tem_dethorcla').html('Carrera:\nMateria:\nPlan:\nDetalle:');
                    break;
                case 2:
                    $('#tem_dethorcla').html('Carrera:\nMateria:\nPlan:\nTema:\nNro Estudiantes:');
                    break;
                case 4: //clase virtual
                    $('#tem_dethorcla').html('Carrera:\nMateria:\nTema:\nDocente:');
                    break;
                case 3:
                    $('#tem_dethorcla').html('Carrera:\nMateria:\nDocente:\nTiempo:');
                    break;
                default:
                    break;
            }
        });
        $('#pri_dethorcla1').chosen().change(function() {
            switch (parseInt($(this).val())) {
                case 1:
                    $('#tem_dethorcla1').html('Carrera:\nMateria:\nPlan:\nDetalle:');
                    break;
                case 2:
                    $('#tem_dethorcla1').html('Carrera:\nMateria:\nPlan:\nTema:\nNro Estudiantes:');
                    break;
                case 4: //clase virtual
                    $('#tem_dethorcla1').html('Carrera:\nMateria:\nTema:\nDocente:');
                    break;
                case 3:
                    $('#tem_dethorcla1').html('Carrera:\nMateria:\nDocente:\nTiempo:');
                    break;
                default:
                    break;
            }
        });
        var tablaDetalleHorario = $('#tabla').DataTable({
            dom: "<'row'<'col-sm-7'f><'col-sm-2'l><'col-sm-5'i>><'row'<'col-sm-12'tr>><'row'<'col-sm-5'i><'col-sm-7'p>>",

            "ordering": false,
            "oLanguage": {
                "sUrl": "../../js/Spanish.lang"
            },
            "processing": true,
            "serverSide": true,
            "ajax": {
                "type": "POST",
                "url": "../horarioclase/lista_detalle",
                "data": function(d) {
                    d.estado = true;
                    d.cod_horcla = '$horario.cod_horcla';
                }
            },
            "columnDefs":[{targets: [2,3,4],className:'text-right'}],
            "columns": [{
                "data": "persona"
            }, {
                "data": "tem_dethorcla"
            }, {
                "data": "horini"
            }, {
                "data": "horfin"
            }, {
                "data": "cod_dethorcla"
            }],
            "createdRow": function(row, data, index) {
                $('td', row).eq(4).html('<div class="btn-group"><button class="btn btn-info modificar" data-codigo="' + data.cod_horcla + '" data-id="' + data.cod_dethorcla + '" data-toggle="tooltip" data-placement="top" title="Modificar"><i class="glyphicon glyphicon-edit"></i> | editar </button><button class="btn btn-danger eliminar" data-codigo="' + data.cod_horcla + '" data-id="' + data.cod_dethorcla + '" data-toggle="tooltip" data-placement="top" title="Eliminar"><i class="glyphicon glyphicon-remove-sign"></i> | eliminar </button></div>');

            },
            "drawCallback": function(settings) {
                $('.eliminar').click(function() {
                	let obj = tablaDetalleHorario.row($(this).closest('tr')).data();
                	alertEliminacion("Eliminacion Detalle de Horario", ("Estudiante: "+ obj.persona+", Hora de inicio: "+obj.horini+', Hora final: '+obj.horfin), function(){
        				jQuery.post('../horarioclase/eliminarDetalle?cod_horcla='+obj.cod_horcla+'&cod_dethorcla='+obj.cod_dethorcla, function(resp){
        					if(resp.status){
        						$('#tabla').dataTable().fnDraw('page');
        						mostrarMensaje('success', resp.msg);
        					}else{
        						modalAlert('Error de eliminacion', resp.msg,'error');
        					}
        				});
        			});
                });
                $('.modificar').click(function() {
                    $('#formularioModificar').data('formValidation').resetForm();
                    $('#formularioModificar')[0].reset();
                    $.post('../horarioclase/obtenerDetalle?cod_dethorcla=' + $(this).data('id') + '&cod_horcla=' + $(this).data('codigo'), function(result) {
                        if (result.status == true) {
                        	$('#formularioModificar').loadJSON(result.data);
                        	$('#cod_per1').val(result.data.cod_per).trigger('chosen:updated');
                            $('#pri_dethorcla1').val(result.data.pri_dethorcla).trigger('chosen:updated');
                            $('#horini1').val(result.data.horini);
                            $('#horfin1').val(result.data.horfin);
                            $('#modalModificar').modal('show');
                        } else {
                            mostrarMensaje('error', 'No se realizo con exito la Transaccion');
                        }
                    }, 'json');
                });
                $('.imprimir').click(function() {
                    $("#frameReportes").attr("src", "../horarioclase/ver_detalle?cod_horcla=$cod_horcla&cod_dethorcla=" + $(this).data('id'));
                    $("#reportes").modal('show');
                });
                $('button[data-toggle="tooltip"]').tooltip({
                    animated: 'fade',
                    placement: 'bottom',
                });

            }
        });
        $('#btnVolver').click(function() {
            $.post('../horarioclase/gestion', function(resp) {
                $('#contenedor').html(resp);
            });
        });
        $('#btnImprimir').click(function() {
            $("#frameReportes").attr("src", "../horarioclase/ver_detalle?cod_horcla=$!{cod_horcla}");
            $("#reportes").modal('show');
        });
        $('#btnAdicionar').click(function() {
            $('#cod_per').val('').trigger('chosen:updated');
            $('#formulario').data('formValidation').resetForm();
            $('#formulario')[0].reset();
            $('#modalAdicionar').modal('show');
        });
        $('#formulario,#formularioModificar').formValidation({
            locale: 'es_ES'
        }).on('success.form.fv', function(e) {
            e.preventDefault();
            alertAdicion('Confirmar transaccion', 'Esta seguro de realizar la transaccion?',function(){
            var xform = $(e.target);
            $.post(xform.attr('action'), xform.serialize(), function(result) {
                if (result.status == true) {
                    xform.data('formValidation').resetForm();
                    $('.modal').modal('hide');
                    $('#tabla').dataTable().fnDraw('page');
                    mostrarMensaje('info', 'Se realizo con exito la Transaccion');
                } else {
                    mostrarMensaje('error', 'No se realizo con exito la Transaccion');
                }
            }, 'json');
            });
        });
    });
</script>