<section xmlns:th="http://www.thymeleaf.org">
    <div id="modalRevisarVer" class="modal fade" data-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Informacion del Movimiento</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-2"></div>
                        <div class="col-md-8 w3-card-4">
                            <table class="w3-table ">
                                <tbody>
                                    <tr>
                                        <td width="30%" class="w3-right-align">Movimiento ID:</td>
                                        <td width="20%" aria-label="id" class="w3-right-align"></td>
                                        <td width="20%" class="w3-right-align">Estado:</td>
                                        <td class="w3-right-align" aria-label="xestadoMovimiento"></td>
                                    </tr>
                                    <tr>
                                        <td class="w3-right-align">Tipo de movimiento:</td>
                                        <td colspan="3" aria-label="xtipo" class="w3-right-align"></td>
                                    </tr>
                                    <tr class="areaVerSucursal" style="display: none">
                                        <td class="w3-right-align">Sucursal origen:</td>
                                        <td colspan="3" aria-label="xsucursalOrigen" class="w3-right-align"></td>
                                    </tr>
                                    <tr  class="areaVerSucursal" style="display: none">
                                        <td class="w3-right-align">Sucursal destino:</td>
                                        <td colspan="3" aria-label="xsucursalDestino" class="w3-right-align"></td>
                                    </tr>
                                    <tr>
                                        <td class="w3-right-align">Registrado en fecha:</td>
                                        <td colspan="3" aria-label="xcreatedAt" class="w3-right-align"></td>
                                    </tr>
                                    <tr>
                                        <td class="w3-right-align">Registrado Por:</td>
                                        <td colspan="3" aria-label="xcreatedBy" class="w3-right-align"></td>
                                    </tr>
                                    <tr>
                                        <td class="w3-right-align">Revisado Por:</td>
                                        <td colspan="3" aria-label="xusuarioRevision" class="w3-right-align"></td>
                                    </tr>
                                    <tr>
                                        <td class="w3-right-align">Revisado en fecha:</td>
                                        <td colspan="3" aria-label="xfechaRevision" class="w3-right-align"></td>
                                    </tr>
                                    <tr>
                                        <td class="w3-right-align">Observacion:</td>
                                        <td colspan="3" aria-label="obs" class=""></td>
                                    </tr>
                                </tbody>
                            </table>

                        </div>
                        <div class="col-md-2"></div>
                        <div class="col-md-12">
                            <br><br>
                            <table id="areaDetallesVer" class="w3-table-all">
                                <thead>
                                <tr>
                                    <th width="5%">No.</th>
                                    <th>Producto</th>
                                    <th width="20%">Tipo <br>Movimiento</th>
                                    <th width="10%">Cantidad</th>
                                    <th>Medida</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-social btn-google" data-dismiss="modal"><i class="glyphicon glyphicon-remove-sign"></i> Salir</button>
                </div>
            </div>
        </div>
    </div>
    <form id="formularioRevisar" autocomplete="off" method="post" action="../movimiento/revisar" data-backdrop="static" data-fv-framework="bootstrap" data-fv-excluded="disabled" data-fv-icon-valid="glyphicon glyphicon-ok" data-fv-icon-invalid="glyphicon glyphicon-remove" data-fv-icon-validating="glyphicon glyphicon-refresh">
        <div id="modalRevisar" class="modal fade" data-backdrop="static">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Revision del Movimiento de Inventario</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-9">
                                <table id="areaDetalles" class="w3-table-all">
                                    <thead>
                                    <tr>
                                        <th width="5%">No.</th>
                                        <th>Producto</th>
                                        <th width="20%">Tipo <br>Movimiento</th>
                                        <th width="10%">Cantidad</th>
                                        <th>Medida</th>
                                    </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Movimiento ID</label>
                                    <input type="text"  class="form-control text-right" name="id" readonly/>
                                </div>
                                <div class="form-group">
                                    <label>Registrado Por</label>
                                    <input type="text" name="xcreatedBy" class="form-control text-right  input-xs" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Fecha Registro</label>
                                    <input type="text" name="xcreatedAt" class="form-control text-right  input-xs" readonly>
                                </div>
                                <div class="form-group areaDestinoRevisar" style="display: none">
                                    <label>Sucursal Origen</label>
                                    <input type="text" class="form-control text-right  input-xs" name="xsucursalOrigen" readonly>
                                </div>
                                <div class="form-group areaDestinoRevisar" style="display: none">
                                    <label>Sucursal Destino</label>
                                    <input type="text" class="form-control text-right input-xs" name="xsucursalDestino" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Observacion</label>
                                    <textarea name="obs" rows="3" class="form-control input-xs" disabled></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Revisar Movimiento</label>
                                    <div class="radio">
                                        <label for="aceptado">
                                            <input type="radio" name="estadoMovimiento"  id="aceptado" value="1" data-fv-notempty="true"/> Aceptado
                                        </label>
                                        <label for="rechazado" style="margin-left: 15px;">
                                            <input type="radio" name="estadoMovimiento"  id="rechazado" value="2" data-fv-notempty="true" /> Rechazado
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-social btn-google" data-dismiss="modal"><i class="glyphicon glyphicon-remove-sign"></i> Cancelar</button>
                        <button type="submit" class="btn btn-social btn-bitbucket"><i class="glyphicon glyphicon-floppy-disk"></i> Guardar</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <div class="box box-primary">
    <div class="box-header with-border">
        <div class="row">
            <div class="col-md-8">
                <h1><span class="fa  fa-ellipsis-v"></span> Movimiento de Inventario</h1>
            </div>
            <div class="col-md-4">
                <div class="btn-group btn-group-justified">
                    <label class="btn btn-primary active estadoRadio"> <input
                            type="radio" name="estado" value="true" title="Mostrar Activos" checked> Activos
                    </label> <label class="btn btn-danger estadoRadio" title="Mostrar Inactivos"> <input
                        type="radio" name="estado" value="false"> Inactivos
                </label>
                </div>
            </div>
        </div>
    </div>
    <div class="box-body">
        <table id="tabla" class="table table-striped table-bordered dt-responsive" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th class="none">ID</th>
                    <th class="all">Fecha</th>
                    <th class="desktop">Tipo</th>
                    <th class="desktop">Estado</th>
                    <th class="all">Accion</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <!-- /.box-body -->
</div>
<!-- /.box -->
    <script th:inline="javascript">
        var sucursalSesionada = /*[[${sucursalSesionada}]]*/ 0;
    </script>
<script type="text/javascript" th:inline="none">
    var dataReq = {
        xestadoMovimiento: ['<span class="badge label-warning">Pendiente</span>','<span class="badge label-success">Aceptado</span>', '<span class="badge label-danger">Rechazado</span>'],
        xtipo: ['','Transpaso <br> sucursal', 'Registro<br>movimiento','Modificacion<br>Almacen','Modificacion<br>Cierre Cartilla','Registro<br>Cartilla Diaria','Modificacion<br>Cartilla Diaria'],
        xtipoVer: ['','Transpaso sucursal', 'Registro movimiento','Modificacion Almacen','Modificacion Cierre de Cartilla','Registro de Cartilla Diaria','Modificacion de Cartilla Diaria']
    }

    $(document).ready(function() {

        $('#tabla').DataTable({
            buttons: [{
                text: 'Adicionar',
                className: "btn-primary btn-block active",
                action: function(e, dt, node, config) {
                    $.post('../movimiento/adicionar', function(resp){
                        $('#contenedor').html(resp);
                    })
                }
            }],
            "ajax": {
                "type": "POST",
                "url": "../movimiento/listar",
                "data": function(d) {
                    d.estado = $('input[name=estado]:checked').val();
                }
            },
            "columnDefs":[{targets: [4],className:'text-right'},{targets: [2,3],className:'w3-center'}],
            "ordering":true,
            "order":[[0,'desc']],
            "columns": [{
                "data": "id","name":"id"
            }, {
                "data": "createdAt","name":"created_at"
            }, {
                "data": "tipo","name":"tipo"
            }, {
                "data": "estadoMovimiento","name":"estado_movimiento"
            }, {
                "data": "id","name":"id"
            }],
            "createdRow": function(row, data, index) {
                $('td', row).eq(1).html(UtilDate.formatTimestampLiteral(data.createdAt));
                $('td', row).eq(2).html(dataReq.xtipo[data.tipo]);
                $('td', row).eq(3).html(dataReq.xestadoMovimiento[data.estadoMovimiento]);
                if (data.estado) {
                    let buttons = '<button class="btn btn-success imprimir"  data-toggle="tooltip" data-placement="top" title="Imprimir Movimiento"><i class="fa fa-print"></i><br>imprimir </button>';
                    buttons += '<button class="btn btn-info ver"  data-toggle="tooltip" data-placement="top" title="Ver Movimiento"><i class="fa fa-eye"></i><br>ver </button>';
                    if(data.estadoMovimiento === 0) {
                        if(data.tipo === 1 ) {
                            if(data.sucursalDestino === sucursalSesionada) {
                                buttons += '<button class="btn btn-primary revisar"  data-toggle="tooltip" data-placement="top" title="Revisar Movimiento"><i class="fa fa-edit"></i><br>revisar </button>';
                            }
                        } else {
                            buttons += '<button class="btn btn-primary revisar"  data-toggle="tooltip" data-placement="top" title="Revisar Movimiento"><i class="fa fa-edit"></i><br>revisar </button>';
                        }
                        buttons += '<button class="btn btn-danger eliminar"  data-toggle="tooltip" data-placement="top" title="Eliminar"><i class="glyphicon glyphicon-remove"></i><br>eliminar</button>';
                    }
                    $('td', row).eq(4).html('<div class="btn-group btn-group-xs">'+buttons+'</div>');
                } else {
                    $('td', row).eq(4).html('');
                }
            },
            "drawCallback": function(settings) {
                $('.eliminar').click(function() {
                    let obj = $('#tabla').DataTable().row($(this).closest('tr')).data();
                    alertEliminacion('Eliminar Movimiento', 'Esta seguro de eliminar el movimiento: #'+ obj.id, function(){
                        $.post('../movimiento/eliminar',{'movimientoId':obj.id }, function(resp){
                            finishTransaction(resp, function(){
                                $('.modal').modal('hide');
                                $('#tabla').dataTable().fnDraw('page');
                            });
                        })
                    })
                });
                $('.revisar').click(function() {
                    let obj = $('#tabla').DataTable().row($(this).closest('tr')).data();
                    if(obj.tipo === 1) { //Si es traspaso entre sucursales
                        $('.areaDestinoRevisar').show()
                    } else {
                        $('.areaDestinoRevisar').hide();
                    }
                    obj.xcreatedAt = moment(obj.createdAt).format('DD/MM/YYYY HH:mm a');
                    $('#formularioRevisar').data('formValidation').resetForm();
                    $('#formularioRevisar')[0].reset();
                    $('#areaDetalles > tbody').html('');
                    $.post('../movimiento/obtenerDetalles?movimientoId='+obj.id, function(resp){
                        finishTransaction(resp, function(){
                            if(resp.data && resp.data.length > 0) {
                                let ind = 1;
                                resp.data.forEach(it => {
                                    let row = $('<tr></tr>');
                                    $('<td style="vertical-align: bottom;">'+ind+'</td>').appendTo(row);
                                    $('<td style="vertical-align: bottom;">#'+it.productoId + ' - '+it.xproducto+'</td>').appendTo(row);
                                    $('<td style="vertical-align: bottom;">'+(it.esIngreso === true ? '<span class="badge label-success">Ingreso</span>':'<span class="badge label-danger">Salida</span>')+'</td>').appendTo(row);
                                    $('<td style="vertical-align: bottom;" class="w3-center">'+it.cantidad+'</td>').appendTo(row);
                                    $('<td style="vertical-align: bottom;">'+(it.tipo === true ? 'Unidades':'Cajas')+'</td>').appendTo(row);
                                    ind++;
                                    $('#areaDetalles > tbody:last').append(row);
                                });
                            } else {
                                $('#areaDetalles > tbody:last').append($('<tr><td colspan="4" class="w3-center">Sin detalles</td></tr>'));
                            }
                            $('#formularioRevisar').loadJSON(obj);
                        })
                    })
                    $('#modalRevisar').modal('show');
                });
                $('.ver').click(function() {
                    let obj = $('#tabla').DataTable().row($(this).closest('tr')).data();
                    $('#areaDetallesVer > tbody').html('');
                    $.post('../movimiento/obtener?movimientoId='+obj.id, function(resp){
                        finishTransaction(resp, function(){
                            if(resp.data && resp.data.detalles.length > 0) {
                                let ind = 1;
                                resp.data.detalles.forEach(it => {
                                    let row = $('<tr></tr>');
                                    $('<td style="vertical-align: bottom;">'+ind+'</td>').appendTo(row);
                                    $('<td style="vertical-align: bottom;">#'+it.productoId + ' - '+it.xproducto+'</td>').appendTo(row);
                                    $('<td style="vertical-align: bottom;">'+(it.esIngreso === true ? '<span class="badge label-success">Ingreso</span>':'<span class="badge label-danger">Salida</span>')+'</td>').appendTo(row);
                                    $('<td style="vertical-align: bottom;" class="w3-center">'+it.cantidad+'</td>').appendTo(row);
                                    $('<td style="vertical-align: bottom;">'+(it.tipo === true ? 'Unidades':'Cajas')+'</td>').appendTo(row);
                                    ind++;
                                    $('#areaDetallesVer > tbody:last').append(row);
                                });
                            } else {
                                $('#areaDetallesVer > tbody:last').append($('<tr><td colspan="4" class="w3-center">Sin detalles</td></tr>'));
                            }
                            resp.data.xestadoMovimiento = dataReq.xestadoMovimiento[resp.data.estadoMovimiento];
                            resp.data.xtipo = dataReq.xtipoVer[resp.data.tipo];
                            resp.data.xcreatedAt = UtilDate.formatTimestampLiteral(resp.data.createdAt);
                            resp.data.xfechaRevision = UtilDate.formatTimestampLiteral(resp.data.fechaRevision);
                            if(resp.data.tipo === 1) {
                                $('.areaVerSucursal').show();
                            } else {
                                $('.areaVerSucursal').hide();
                            }
                            $('#modalRevisarVer').loadJSON(resp.data);
                        })
                    })
                    $('#modalRevisarVer').modal('show');
                });
                $('.imprimir').click(function() {
                    let obj = $('#tabla').DataTable().row($(this).closest('tr')).data();
                    $("#frameReportes").attr("src", "../movimiento/ver?id=" + obj.id);
                    $("#reportes").modal('show');
                });
                $('button[data-toggle="tooltip"]').tooltip({
                    animated: 'fade',
                    placement: 'bottom',
                });
            },
            "initComplete": function(settings, json){
                $('#tabla_filter input').unbind();
                $('#tabla_filter input').bind('keyup', function(e) {
                    if(e.keyCode == 13) {
                        $('#tabla').DataTable().search(this.value).draw();
                    }
                })
            }
        });
        $('.estadoRadio').click(function() {
            $('#tabla').dataTable().fnDraw('page');
        });
        $('#formularioRevisar').formValidation({
            locale: 'es_ES'
        }).on('success.form.fv', function(e) {
            e.preventDefault();
            alertAdicion('Confirmar transaccion','Esta seguro de realizar la transaccion.',function(){
                var xform = $(e.target);
                $.post(xform.attr('action'), xform.serialize(), function(result) {
                    finishTransaction(result, function(){
                        $('.modal').modal('hide');
                        $('#tabla').dataTable().fnDraw();
                    })
                }, 'json');
            })
        });
    });
</script>
</section>