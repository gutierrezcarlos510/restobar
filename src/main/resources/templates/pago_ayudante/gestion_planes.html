<div class="box box-primary">
    <div class="box-header with-border">

        <div id="modalPagar" class="modal fade">
            <div class="modal-dialog" style="width: 80%">
                <form id="formularioPagar" method="post" action="../ayudante/pagar_inscripcion" data-fv-framework="bootstrap" data-fv-excluded="disabled" data-fv-icon-valid="glyphicon glyphicon-ok" data-fv-icon-invalid="glyphicon glyphicon-remove" data-fv-icon-validating="glyphicon glyphicon-refresh">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title">Pagar a Ayudante por Plan</h4>
                        </div>
                        <div class="modal-body">
                            <label>Plan : <b id="planLabel"></b></label>
                            <div class="table-responsive">
                                <table id="detalles" class="table  table-bordered" cellspacing="0" width="100%">
                                    <thead>
                                        <tr align="center">
                                            <th colspan="5">Lista de Inscritos</th>
                                        </tr>
                                        <tr>
                                            <th width="25px">No.</th>
                                            <th>Fecha</th>
                                            <th>Usuario</th>
                                            <th>Estudiante</th>
                                            <th width="100px">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                    <tfoot>
                                        <tr align="right">
                                            <td colspan="4">Total</td>
                                            <td id="total-final"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Ayudante</label>
                                        <select id="cod_matplaayu" name="cod_matplaayu" class="form-control input-md" data-placeholder="Selecccionar..." data-fv-notempty>
                  				<option value=""></option>
                  				#foreach($a in $ayudantes)
                  				<option value="$a.cod_matplaayu">$a.ayudante</option>
                  				#end
                  				</select>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Total X Ayudante</label>
                                        <input type="text" class="form-control" id="subtotal" name="subtotal" readonly="readonly">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Porcentaje</label>
                                        <input type="text" class="form-control" id="porcentaje" name="porcentaje" data-fv-notempty="true" data-fv-numeric="true">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Total a Pagar</label>
                                        <input type="text" class="form-control" id="total" name="total" readonly="readonly">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger pull-left" data-dismiss="modal"><i class="fa fa-times-circle"></i> Cancelar</button>
                            <button type="submit" class="btn btn-primary"><i class="fa fa-check-circle"></i> Aceptar</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </form>
            </div>
            <!-- /.modal-dialog -->
        </div>
        <!-- /.modal -->

        <div class="box-tools pull-right">
            <button class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip" title="Collapse"><i class="fa fa-minus"></i></button>
            <button class="btn btn-box-tool" data-widget="remove" data-toggle="tooltip" title="Remove"><i class="fa fa-times"></i></button>
        </div>
    </div>
    <div class="box-body">
        <div class="row">
            <div class="col-md-8">
                <h1 class="pull-left"><span class="fa  fa-ellipsis-v"></span> Pago a Ayudantes por Plan</h1>
            </div>
        </div>



        <table id="tabla" class="table table-striped table-bordered" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Sigla</th>
                    <th>Plan</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>
    <!-- /.box-body -->
</div>
<!-- /.box -->
<script>
    $(document).ready(function() {
        $('select').chosen({
            no_results_text: "No se encuentra:",
            width: '100%'
        });

        $('#tabla').dataTable({
            dom: "<'row'<'col-sm-5'f><'col-sm-2'l><'col-sm-5'i>><'row'<'col-sm-12'tr>><'row'<'col-sm-5'i><'col-sm-7'p>>",
            "ordering": false,
            "oLanguage": {
                "sUrl": "../../js/Spanish.lang"
            },
            "processing": true,
            "serverSide": true,
            "ajax": {
                "type": "POST",
                "url": "../inscripcion/lista_pago_plan",
                "data": function(d) {
                    d.estado = true;
                    d.tipo = 2;
                }
            },
            "columns": [{
                "data": "sig_pla"
            }, {
                "data": "nom_pla"
            }, {
                "data": "cod_pla"
            }],
            "createdRow": function(row, data, index) {
                $('td', row).eq(2).html('<div class="btn-group"><button class="btn btn-primary pagar"  data-toggle="tooltip" data-placement="top" title="Pagar por inscripcion" data-id="' + data.cod_pla + '"><i class="fa fa-dollar"></i> </button></div>');
            },
            "drawCallback": function(settings) {
                $('.pagar').click(function() {
                    $('#formularioPagar')[0].reset();
                    $('#formularioPagar').data('formValidation').resetForm();
                    $.post('../inscripcion/obtener_plan_pago?cod_pla=' + $(this).data('id'), function(result) {
                        if (result.status == true) {
                            $('#modalPagar').modal('show');
                            $('#planLabel').html(result.plan.sig_pla + ' ' + result.plan.nom_pla);
                            $('#cod_matplaayu').html('');
                            var row1 = $('<option value="" selected></option>');
                            $('#cod_matplaayu').append(row1);
                            $.each(result.ayudantes, function(index, item) {
                                var row = $('<option value="' + item.cod_matplaayu + '">' + item.ayudante + '</option>');
                                $('#cod_matplaayu').append(row);
                            });
                            $('#cod_matplaayu').trigger('chosen:updated');
                            $('#detalles > tbody').html('');
                            var indice = 0,
                                monto = 0;
                            $.each(result.inscripciones, function(i, item) {
                                indice++;
                                monto = monto + item.tot_ins;
                                var row = $('<tr></tr>');
                                $('<td>' + indice + '</td>').appendTo(row);
                                $('<td>' + item.fecha + '</td>').appendTo(row);
                                $('<td>' + item.usuario + '</td>').appendTo(row);
                                $('<td>' + item.estudiante + '</td>').appendTo(row);
                                $('<td>' + item.tot_ins + '</td>').appendTo(row);
                                $('#detalles > tbody:last').append(row);
                            });
                            var promedio = monto / indice;
                            $('#total-final').html(promedio.toFixed(2) + ' Bs.');
                            $('#subtotal').val(promedio.toFixed(2));
                            $('#porcentaje').val(100);
                            $('#total').val(promedio.toFixed(2));
                        } else {
                            mostrarMensaje('error', 'No se realizo con exito la Transaccion');
                        }
                    }, 'json');
                });
                $('button[data-toggle="tooltip"]').tooltip({
                    animated: 'fade',
                    placement: 'bottom',
                });
            }
        });
        $('#formularioPagar').formValidation({
            locale: 'es_ES'
        }).on('success.fv.field', '[name="porcentaje"]', function() {
            var res = parseFloat($('#subtotal').val()) * parseFloat($('#porcentaje').val()) / 100;
            $('#total').val(res.toFixed(2));
        }).on('err.field.fv', function(e) {
            $('#total').val(0);
        }).on('success.form.fv', function(e) {
            e.preventDefault();
            var xform = $(e.target);
            $.post(xform.attr('action'), xform.serialize(), function(result) {
                if (result.status == true) {
                    xform.data('formValidation').resetForm();
                    $('.modal').modal('hide');
                    $('#tabla').dataTable().fnDraw('page');
                    mostrarMensaje('info', 'Se realizo con exito la Transaccion');
                } else {
                    mostrarMensaje('error', 'No se realizo con exito la Transaccion');
                }
            }, 'json');
        });

    });

    function calcular() {
        var tot = 0;
        $('.datos').each(function() {
            if ($(this).is(':checked'))
                tot += parseFloat($(this).data('saldo'));
        });
        $('#total-final').html(tot.toFixed(2) + ' Bs.');
    }

    function subcalcular(porcentaje, codigo, total) {
        if (porcentaje != '') {
            var res = parseFloat(total) * parseFloat(porcentaje) / 100;
            $('#sal-' + codigo).val(res.toFixed(2));
            $('#cod-' + codigo).val(codigo + '-' + res.toFixed(2));
            $('#cod-' + codigo).data('saldo', res.toFixed(2));
            calcular();
        } else
            $('#sal-' + codigo).val(0);
    }
</script>