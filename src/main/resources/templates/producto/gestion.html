<section xmlns:th="http://www.thymeleaf.org">
<div class="box box-primary">
    <div class="box-header with-border">
        <form id="formulario" method="post" action="../producto/guardar" data-fv-framework="bootstrap" data-fv-excluded="disabled" data-fv-icon-valid="glyphicon glyphicon-ok" data-fv-icon-invalid="glyphicon glyphicon-remove" data-fv-icon-validating="glyphicon glyphicon-refresh">
            <div id="modalAdicionar" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title">Adicionar Producto</h4>
                        </div>
                        <div class="modal-body">
                        <input type="hidden" name="can_pro" value="0" />
                        <div class="form-group">
                                        <label>Tipo de Producto</label>
                                        <select id="cod_tippro" name="cod_tippro" class="form-control input-md select-chosen" data-placeholder="Selecccionar..." data-fv-notempty>
                  				<option value=""></option>
                  				<option th:each="t : ${tipos}" th:value="${t.cod_tippro}" th:text="${t.nom_tippro}"></option>
                  			</select>
                                    </div>
                            <div class="form-group">
                                        <label>Nombre</label>
                                        <input type="text" class="form-control text-uppercase" id="nom_pro" name="nom_pro" data-fv-notempty="true">
                                    </div>
                            <div class="form-group">
                                        <label>Precio Compra</label>
                                        <input type="text" class="form-control" id="precom_pro" name="precom_pro" data-fv-notempty="true" onClick="this.setSelectionRange(0, this.value.length)">
                                    </div>
                            <div class="form-group">
                                        <label>Ganancia</label>
                                        <input type="text" class="form-control" id="gan_pro" name="gan_pro" data-fv-notempty="true" onClick="this.setSelectionRange(0, this.value.length)">
                                    </div>
                                    <div class="form-group">
                                        <label>Precio Venta</label>
                                        <input type="text" class="form-control" id="preven_pro" name="preven_pro" data-fv-notempty="true" readonly="readonly">
                                    </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-social btn-google" data-dismiss="modal"><i class="glyphicon glyphicon-remove-sign"></i> Cancelar</button>
                            <button type="submit" id="btnAdicionarConfirmacion" class="btn btn-social btn-bitbucket"><i class="glyphicon glyphicon-floppy-disk"></i> Guardar</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
        </form>
        <form id="formularioModificar" method="post" action="../producto/actualizar" data-fv-framework="bootstrap" data-fv-excluded="disabled" data-fv-icon-valid="glyphicon glyphicon-ok" data-fv-icon-invalid="glyphicon glyphicon-remove" data-fv-icon-validating="glyphicon glyphicon-refresh">
            <div id="modalModificar" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title">Modificar Producto</h4>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="cod_pro1" name="cod_pro" />
                            <div class="form-group">
                                        <label>Tipo de Producto</label>
                                        <select id="cod_tippro1" name="cod_tippro" class="form-control input-md select-chosen" onClick="this.setSelectionRange(0, this.value.length)" data-placeholder="Selecccionar..." data-fv-notempty>
                  				<option value=""></option>
                  				<option th:each="t : ${tipos}" th:value="${t.cod_tippro}" th:text="${t.nom_tippro}"></option>
                  			</select>
                                    </div>
                            <div class="form-group">
                                        <label>Nombre</label>
                                        <input type="text" class="form-control text-uppercase" id="nom_pro1" onClick="this.setSelectionRange(0, this.value.length)" name="nom_pro" data-fv-notempty="true">
                                    </div>
                            <div class="form-group">
                                        <label>Precio Compra</label>
                                        <input type="text" class="form-control" id="precom_pro1" name="precom_pro" data-fv-notempty="true" onClick="this.setSelectionRange(0, this.value.length)">
                                    </div>
                            <div class="form-group">
                                        <label>Ganancia</label>
                                        <input type="text" class="form-control" id="gan_pro1" name="gan_pro" data-fv-notempty="true" onClick="this.setSelectionRange(0, this.value.length)">
                                    </div>
                            <div class="form-group">
                                        <label>Precio Venta</label>
                                        <input type="text" class="form-control" id="preven_pro1" name="preven_pro" data-fv-notempty="true" readonly="readonly">
                                    </div>
<!--                            <div class="form-group">-->
<!--                                <label>Cantidad</label>-->
<!--                                <input type="text" class="form-control" id="can_pro1" name="can_pro" data-fv-notempty="true">-->
<!--                            </div>-->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-social btn-google" data-dismiss="modal"><i class="glyphicon glyphicon-remove-sign"></i> Cancelar</button>
                            <button type="submit" id="btnModificarConfirmacion" class="btn btn-social btn-bitbucket"><i class="glyphicon glyphicon-floppy-disk"></i> Guardar</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <div id="modalAsignar" class="modal fade">
            <div class="modal-dialog modal-sm">
                <form id="formularioAsignar" method="post" action="../producto/asignar" data-fv-framework="bootstrap" data-fv-excluded="disabled" data-fv-icon-valid="glyphicon glyphicon-ok" data-fv-icon-invalid="glyphicon glyphicon-remove" data-fv-icon-validating="glyphicon glyphicon-refresh">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title">Asignar Codigo de Barra Producto</h4>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="cod_pro" name="cod_pro" />
                            <p>Producto : <label id="productoLabel3"></label></p>
                            <div class="form-group">
                                <label class="control-label">C&oacute;digo </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="code1" name="codigos" />
                                    <span class="input-group-btn">
            					<button type="button" class="btn btn-primary addButton" title="Adicionar codigo"><i class="fa fa-plus"></i></button>
            					<button type="button" class="btn btn-default">_</button>
            				</span>
                                </div>
                            </div>
                            <div id="contentCodes">
                            </div>
                            <div class="form-group hide" id="optionTemplate">
                                <div class="input-group">
                                    <input class="form-control" type="text" name="codigos" />
                                    <span class="input-group-btn">
            				<button type="button" class="btn btn-danger removeButton" title="Eliminar codigo"><i class="fa fa-minus"></i></button>
            				<button type="button" class="btn btn-default">_</button>
        				</span>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-social btn-google" data-dismiss="modal"><i class="glyphicon glyphicon-remove-sign"></i> Cancelar</button>
                            <button type="submit" class="btn btn-social btn-bitbucket"><i class="glyphicon glyphicon-ok-sign"></i> Asignar</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </form>
            </div>
            <!-- /.modal-dialog -->
        </div>
        <!-- /.modal -->
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-5">
                <h1><span class="fa  fa-ellipsis-v"></span> Productos </h1>
            </div>
            <div class="col-xs-12 col-sm-12 col-md-3">
                <button class="btn btn-block btn-success" id="btnImprimirInventario"><i class="fa fa-print"></i> Imprimir inventario</button>
            </div>
            <div class="col-xs-12 col-sm-12 col-md-4">
                <div class="btn-group btn-group-justified padding-top-sm">
                    <label class="btn btn-primary active estadoRadio"> <input
                            type="radio" name="estado" value="true" title="Mostrar Activos" checked> Activos
                    </label> <label class="btn btn-danger estadoRadio" title="Mostrar Inactivos"> <input
                        type="radio" name="estado" value="false"> Inactivos
                </label>
                </div>
            </div>
        </div>
    </div>
    <div class="box-body">
        <table id="tabla" class="table table-striped table-bordered dt-responsive" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th class="desktop">C&oacute;digo</th>
                    <th class="none">Tipo de producto</th>
                    <th class="all">Nombre</th>
                    <th class="desktop">Cantidad</th>
                    <th class="desktop">P. Compra</th>
                    <th class="desktop">P. Venta</th>
                    <th class="desktop">Ganancia</th>

                    <th class="all">Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <!-- /.box-body -->
</div>
<!-- /.box -->
<script>
	function calculoGanancia(compra, ganancia,venta){
		let pcompra=$(compra).val();
		let gan=$(ganancia).val();
		if(!gan){
			gan = 0;
		}if(!pcompra){
			pcompra = 0;
		}
		let res = parseFloat(pcompra) + parseFloat(gan);
		$(venta).val(res);
	}
    $(document).ready(function() {
        $('.select-chosen').chosen({
            no_results_text: "No se encuentra:",
            width: '100%'
        });
        $('#btnImprimirInventario').click(function() {
            $("#frameReportes").attr("src", "../producto/verInventario");
            $("#reportes").modal('show');
        });
        $('#gan_pro,#precom_pro').keyup(function(){
        	calculoGanancia('#precom_pro','#gan_pro','#preven_pro');
        });
        $('#gan_pro1,#precom_pro1').keyup(function(){
        	calculoGanancia('#precom_pro1','#gan_pro1','#preven_pro1');
        });
        var tablaProducto = $('#tabla').DataTable({
            buttons: [{
                text: 'Adicionar',
                className: "btn-primary btn-block active",
                action: function(e, dt, node, config) {
                    $('#formulario')[0].reset();
                    $('#formulario').data('formValidation').resetForm();
                    $('#cod_tippro').trigger('chosen:updated');
                    $('#modalAdicionar').modal('show');
                }
            }],
            "ajax": {
                "type": "POST",
                "url": "../producto/lista",
                "data": function(d) {
                    d.estado = $('input[name=estado]:checked').val();
                }
            },
            "columnDefs":[
            	{targets: [0],className:'text-center'},
            	{targets: [3,4,5,6,7],className:'text-right'}],
            "columns": [{
                "data": "cod_pro"
            }, {
                "data": "nom_tippro"
            }, {
                "data": "nom_pro"
            }, {
                "data": "can_pro"
            }, {
                "data": "precom_pro"
            }, {
                "data": "preven_pro"
            }, {
                "data": "gan_pro"
            }, {
                "data": "cod_pro"
            }],
            "createdRow": function(row, data, index) {
                if ($('input[name=estado]:checked').val() == 'true') {
                    $('td', row).eq(7).html('<div class="btn-group btn-group-xs"><button class="btn btn-sm btn-warning asignar"  data-toggle="tooltip" data-placement="top" title="Asignar Codigos de barra" data-id="' + data.cod_pro + '"><i class="fa fa-barcode"></i><br>asignar</button><button class="btn btn-primary btn-sm modificar"  data-toggle="tooltip" data-placement="top" title="Modificar" data-id="' + data.cod_pro + '"><i class="fa fa-edit"></i><br>editar</button><button class="btn btn-sm btn-danger eliminar"  data-toggle="tooltip" data-placement="top" title="Eliminar" data-id="' + data.cod_pro + '"><i class="glyphicon glyphicon-remove"></i><br>borrar</button><button class="btn btn-sm btn-success imprimir" data-id="' + data.cod_pro + '" data-toggle="tooltip" data-placement="top" title="Imprimir codigos"><i class="glyphicon glyphicon-barcode"></i></i><br>imprimir </button></div>');
                } else
                    $('td', row).eq(7).html('<button class="btn btn-sm btn-primary activar" data-id="' + data.cod_pro + '" data-toggle="tooltip" data-placement="top" title="Dar de alta"><i class="glyphicon glyphicon-plus-sign"></i><br/>activar</button>');
            },
            "drawCallback": function(settings) {
                $('.eliminar').click(function() {
                    let obj = tablaProducto.row($(this).closest('tr')).data();
                	alertEliminacion("Eliminacion de Producto", ("Cod. producto: "+ obj.cod_pro+", Nombre: "+obj.nom_pro), function(){
        				jQuery.post('../producto/eliminar?cod_pro='+obj.cod_pro, function(resp){
        					if(resp.status){
        						$('#tabla').dataTable().fnDraw('page');
        						mostrarMensaje('success', resp.msg);
        					}else{
        						modalAlert('Error de eliminacion', resp.msg,'error');
        					}
        				});
        			});
                });
                $('.activar').click(function() {
                	let obj = tablaProducto.row($(this).closest('tr')).data();
                	alertAdicion("Activacion de Producto", ("Cod. producto: "+ obj.cod_pro+", Nombre: "+obj.nom_pro), function(){
        				jQuery.post('../producto/activar?cod_pro='+obj.cod_pro, function(resp){
        					if(resp.status){
        						$('#tabla').dataTable().fnDraw('page');
        						mostrarMensaje('success', resp.msg);
        					}else{
        						modalAlert('Error de activacion', resp.msg,'error');
        					}
        				});
        			});
                });
                $('.modificar').click(function() {
                	let obj = tablaProducto.row($(this).closest('tr')).data();
                    $('#formularioModificar').data('formValidation').resetForm();
                    $('#formularioModificar')[0].reset();
                    $('#formularioModificar').loadJSON(obj);
                    $('#cod_tippro1').val(obj.cod_tippro).trigger('chosen:updated');
                    $('#modalModificar').modal('show');
                });
                $('.asignar').click(function() {
                    $('#contentCodes').html('');
                    //$('#formularioAsignar').data('formValidation').resetForm();
                    $('#formularioAsignar')[0].reset();
                    $('#contentCodes').html('');
                    $.post('../producto/obtener?cod_pro=' + $(this).data('id'), function(result) {
                        if (result.status) {
                            if(result.data && result.data.codigos && result.data.codigos.length > 0){
                                result.data.codigos.forEach(function(item,index){
                                    if (index == 0) {
                                        $('#code1').val(item['cod_bar']);
                                    } else {
                                        let cad = '<div class="form-group">' +
                                            '<div class="input-group">' +
                                            '<input class="form-control" type="text" name="codigos" value="' + item['cod_bar'] + '" />' +
                                            '<span class="input-group-btn">' +
                                            '<button type="button" class="btn btn-danger removeButton" title="Eliminar codigo"><i class="fa fa-minus"></i></button>' +
                                            '<button type="button" class="btn btn-default">_</button>' +
                                            '</span>' +
                                            '</div>' +
                                            '</div>';
                                        $(cad).appendTo('#contentCodes');
                                    }
                                });
                                delete result.data.codigos;
                            }
                            $('#modalAsignar').modal('show');
                            $('#formularioAsignar').loadJSON(result.data);
                            $('#productoLabel3').html(result.data.tipo.nom_tippro + ' ' + result.data.nom_pro);
                        } else {
                            mostrarMensaje('error', 'No se realizo con exito la Transaccion');
                        }
                    }, 'json');
                });
                $('.imprimir').click(function() {
                    $("#frameReportes").attr("src", "../producto/imprimir_codigos?cod_pro=" + $(this).data('id'));
                    $("#reportes").modal('show');
                });
                $('button[data-toggle="tooltip"]').tooltip({
                    animated: 'fade',
                    placement: 'bottom',
                });
            }
        });
        $('.estadoRadio').click(function() {
            $('#tabla').dataTable().fnDraw('page');
        });
        $('#formulario,#formularioModificar').formValidation({
            locale: 'es_ES'
        }).on('success.form.fv', function(e) {
            e.preventDefault();
            alertAdicion('Confirmar transaccion', 'Esta seguro de realizar la transaccion?',function(){
            	var xform = $(e.target);
                $.post(xform.attr('action'), xform.serialize(), function(result) {
                    if (result.status == true) {
                        xform.data('formValidation').resetForm();
                        $('.modal').modal('hide');
                        $('#tabla').dataTable().fnDraw('page');
                        mostrarMensaje('info', 'Se realizo con exito la Transaccion');
                    } else {
                        mostrarMensaje('error', 'No se realizo con exito la Transaccion');
                    }
                }, 'json');
            });
        });
        $('#nom_pro').blur(function() {
            var cad = $('#cod_tippro option:selected').text() + ' ' + $(this).val();
            $.post('../producto/validar?nom_pro=' + cad, function(resp) {
                if (resp.status == true) {
                    $('#nom_pro').val('');
                    mostrarMensaje('error', 'Este nombre ya existe!!!');
                }
            });
        });
        var MAX_OPTIONS = 10;

        $('#formularioAsignar')
            .formValidation({
                locale: 'es_ES'
            }).on('success.form.fv', function(e) {
                e.preventDefault();
                var xform = $(e.target);
                $.post(xform.attr('action'), xform.serialize(), function(result) {
                    if (result.status == true) {
                        //xform.data('formValidation').resetForm();
                        $('.modal').modal('hide');
                        $('#tabla').dataTable().fnDraw('page');
                        mostrarMensaje('info', 'Se realizo con exito la Transaccion');
                    } else {
                        mostrarMensaje('error', 'No se realizo con exito la Transaccion');
                    }
                }, 'json');
            }).on('click', '.addButton', function() {
                var $template = $('#optionTemplate'),
                    $clone = $template.clone().removeClass('hide').removeAttr('id').appendTo('#contentCodes'),
                    $option = $clone.find('[name="codigos"]');
                $('#formularioAsignar').formValidation('addField', $option);
                $('button').tooltip({
                    animated: 'fade',
                    placement: 'bottom',
                });
            }).on('click', '.removeButton', function() {
                var $row = $(this).parents('.form-group'),
                    $option = $row.find('[name="codigos"]');
                $row.remove();
                $('#formularioAsignar').formValidation('removeField', $option);
            }).on('added.field.fv', function(e, data) {
                if (data.field === 'codigos') {
                    if ($('#formularioAsignar').find(':visible[name="codigos"]').length >= MAX_OPTIONS) {
                        $('#formularioAsignar').find('.addButton').attr('disabled', 'disabled');
                    }
                }
            }).on('removed.field.fv', function(e, data) {
                if (data.field === 'codigos') {
                    if ($('#formularioAsignar').find(':visible[name="option[]"]').length < MAX_OPTIONS) {
                        $('#formularioAsignar').find('.addButton').removeAttr('disabled');
                    }
                }
            });
    });
</script>
</section>