<style type="text/css">
    .toolbar{
        position: fixed;
        bottom: 0;
        width: 100%;
        padding-bottom: 0px !important;

    }
    div.toolbar .toolbar-bottom {
        text-align:right !important;
        padding-right: 350px;
        margin-bottom:50px;
    }
</style>
<section xmlns:th="http://www.thymeleaf.org">
<form id="formularioCliente" method="post" action="../cliente/guardar" data-fv-framework="bootstrap" data-fv-excluded="disabled" data-fv-icon-valid="glyphicon glyphicon-ok" data-fv-icon-invalid="glyphicon glyphicon-remove" data-fv-icon-validating="glyphicon glyphicon-refresh">
    <div id="modalCliente" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Adicionar Cliente</h4>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="codigo" name="cod_per">
                    <input type="hidden" name="ci_per" value="0">
                    <input type="hidden" name="dir_per" value="">
                    <input type="hidden" name="segape_per" value="">
                    <input type="hidden" name="fot_per" value="user.png">
                    <div class="form-group">
                    	<label>Celular.</label>
                    	<input type="text" class="form-control text-right" id="tel_per" name="tel_per">
                    </div>
                    <div class="form-group">
                    	<label>Nombre</label>
                    	<input type="text" class="form-control text-uppercase" id="nom_per" name="nom_per" data-fv-notempty="true">
                    </div>
                    <div class="form-group">
                    	<label>Apellidos</label>
                    	<input type="text" class="form-control text-uppercase" id="priape_per" name="priape_per" data-fv-notempty="true">
                    </div>
                    <div class="form-group">
                    	<label>Genero</label>
                    	<div class="radio">
                    		<label for="masculino"><input type="radio" id="masculino" name="sex_per" value="true" data-fv-notempty="true"/>Masculino</label>
                    		<label for="femenino"><input type="radio"  id="femenino" name="sex_per" value="false" data-fv-notempty="true"/>Femenino</label>
                    	</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-social btn-google" data-dismiss="modal"><i class="glyphicon glyphicon-remove-sign"></i> Cancelar</button>
                    <button type="submit" id="btnAdicionarConfirmacion" class="btn btn-social btn-bitbucket"><i class="glyphicon glyphicon-floppy-disk"></i> Guardar</button>
                </div>
            </div>
        </div>
    </div>
</form>
    <form id="formularioCompuesto" method="post" action="#" data-fv-framework="bootstrap" data-fv-excluded="disabled" data-fv-icon-valid="glyphicon glyphicon-ok" data-fv-icon-invalid="glyphicon glyphicon-remove" data-fv-icon-validating="glyphicon glyphicon-refresh">
        <div id="modalCompuesto" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Registrar</h4>
                    </div>
                    <div class="modal-body">
                        <div id="contenidoCartilla"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-social btn-google" data-dismiss="modal"><i class="glyphicon glyphicon-remove-sign"></i> Cancelar</button>
                        <button type="submit" class="btn btn-social btn-bitbucket"><i class="glyphicon glyphicon-floppy-disk"></i> Guardar</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <!-- panel preview -->
<div id="smartwizard">
    <ul class="nav" style="display: none;">
        <li class="nav-item">
            <a class="nav-link" href="#step-1">
                <strong>1</strong>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#step-2">
                <strong>Step 2</strong>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#step-3">
                <strong>Step 3</strong>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link " href="#step-4">
                <strong>Step 4</strong>
            </a>
        </li>
    </ul>

    <div class="tab-content" >
        <div style="height: 100vh !important;" id="step-1" class="tab-pane" role="tabpanel" aria-labelledby="step-1">
            <form id="formulario1" name="formulario1" action="#" method="post" data-fv-framework="bootstrap" data-fv-icon-valid="glyphicon glyphicon-ok" data-fv-icon-invalid="glyphicon glyphicon-remove" data-fv-icon-validating="glyphicon glyphicon-refresh">
                <div  class="panel panel-primary">
                    <div class="panel-heading">
                        <h5 class="w3-center">Registro de Venta </h5>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <input type="hidden" name="usuarioId" />
                                    <label>Mesero</label>
                                    <select class="form-control select-chosen" name="usuarioId" id="usuarioId" data-fv-notempty="true">
                                        <option value="">Seleccionar</option>
                                        <option th:each="m : ${meseros}" th:text="${m.nom_per + ' ' + m.priape_per}" th:value="${m.cod_per}"></option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-sm btn-success form-control" title="Adicionar Cliente" id="adicionarCliente"> <span class="glyphicon glyphicon-plus"></span> Cliente Nuevo</button>
                            </div>
                        </div>
                        <h4 class="content-header">Mesa</h4>
                        <div class="row" id="areaMesa"></div>
                        <br><br><br><br><br>
                    </div>
                </div>
            </form>
        </div>
        <div id="step-2" class="tab-pane" role="tabpanel" aria-labelledby="step-2">
            <h5>Productos</h5>
            <div class="row">
                <div class="col-md-3">
                    <table class="w3-table-all w3-card-4" id="tablaDetalleVenta">
                        <thead>
                        <tr>
                            <th>Detalle</th>
                            <th width="20px">Cant.</th>
                            <th width="20px">Medida</th>
                            <th width="20px">Precio</th>
                            <th width="20px">Subtotal</th>
                        </tr>
                        </thead>
                        <tbody>
                        <td colspan="5" class="w3-center">Sin ningun detalle</td>
                        </tbody>
                        <tfoot></tfoot>
                    </table>
                </div>
                <div class="col-md-9">
                    <div class="nav-tabs-custom">
                        <ul class="nav nav-tabs" id="tabCartilla">
                            <li class="active"><a href="#tab_0" data-toggle="tab">Productos</a></li>
                        </ul>
                        <div class="tab-content" id="tabContentCartilla">
                            <div class="tab-pane active" id="tab_0">
                                <div class="row platos-list plato-list-in-box" style="height: 800px;" id="areaProducto"></div>
                            </div><!-- /.tab-pane -->
                        </div><!-- /.tab-content -->
                    </div>
                </div>
            </div>
        </div>
        <div id="step-3" class="tab-pane" role="tabpanel" aria-labelledby="step-3">
            <form id="formulario3" name="formulario3" action="../venta/guardar" method="post" data-fv-framework="bootstrap" data-fv-icon-valid="glyphicon glyphicon-ok" data-fv-icon-invalid="glyphicon glyphicon-remove" data-fv-icon-validating="glyphicon glyphicon-refresh">
                <div class="panel panel-primary">

                    <div class="panel-body">
                        <div class="table-responsive">
                            <table id="detalles" class="w3-table-all w3-tiny">
                                <thead>
                                <tr>
                                    <th width="300px">Producto</th>
                                    <th>Cantidad</th>

                                    <th> Precio </th>
                                    <th>Subtotal</th>
                                    <th>Descuento</th>
                                    <th>Total</th>
                                    <th width="25px">Eliminar</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr id="unit">
                                    <td colspan="7" class="w3-center">Sin ningun detalle</td>
                                </tr>
                                </tbody>
                                <tfoot>

                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div id="step-4" class="tab-pane" role="tabpanel" aria-labelledby="step-4">
            <div class="panel panel-primary">
                <div class="panel-body">
                    <div class="table-responsive">
                        <form id="formulario4" name="formulario4" action="#" method="post">
                            <table class="w3-table-all w3-small">
                                <thead>
                                <tr>
                                    <th colspan="6" class="w3-center">Resumen de venta</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td class="w3-right-align" colspan="4">Subtotal venta</td>
                                    <td colspan="2" width="100px">
                                        <input type="text" id="subtotal" class="form-control input-xs text-right" name="subtotal" value="0" readonly="readonly">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="w3-right-align" colspan="4">Subtotal Descuento</td>
                                    <td colspan="2">
                                        <input type="text" id="subdescuento" class="form-control input-xs text-right" name="subdescuento" value="0" readonly="readonly">
                                    </td>
                                </tr>
                                <tr class="w3-right-align">
                                    <td colspan="4"  class="w3-right-align">Total + descuento</td>
                                    <td colspan="2">
                                        <input type="text" id="subtotal-descuento" class="form-control input-xs text-right" readonly="readonly" name="subtotVen" value="0">
                                    </td>
                                </tr>
                                <tr  class="w3-right-align">
                                    <td colspan="4" class="w3-right-align">Descuento Extra</td>
                                    <td colspan="2"  class="w3-right-align">
                                        <input type="text" id="descuento" name="desVen" min="0" class="form-control input-xs text-right" data-fv-numeric="true" data-fv-numeric-decimalseparator="." value="0" data-fv-notempty="true" onClick="this.setSelectionRange(0, this.value.length)">
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="w3-right-align">Total a Pagar</td>
                                    <td colspan="2">
                                        <input type="text" id="total" class="form-control input-xs text-right" readonly="readonly" name="totVen" value="0">
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="w3-right-align">Forma de pago</td>
                                    <td colspan="2">
                                        <div class="form-group">
                                            <div class="radio">
                                                <label for="ventaEfectivo"><input type="radio" id="ventaEfectivo" class="campoFormaPago" name="formapago" value="0" data-fv-notempty="true" checked="checked"/>En efectivo</label>
                                                <label for="ventaBanco"><input type="radio"  id="ventaBanco" class="campoFormaPago" name="formapago" value="1" data-fv-notempty="true"/>Deposito bancario</label>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="w3-right-align">Total pagado</td>
                                    <td colspan="2">
                                        <div class="form-group">
                                            <input type="text" class="form-control input-xs text-right" id="totalPagado" name="totalPagado"/>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="w3-right-align">Cambio a entregar</td>
                                    <td colspan="2">
                                        <div class="form-group">
                                            <input type="text" class="form-control input-xs text-right" id="totalCambio" name="totalCambio" readonly="readonly"/>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </form>
                    </div>
                </div>
                <div class="panel-footer">
                    <button type="button"  onclick="$('#formulario3').submit();" id="guardar" class="btn btn-primary btn-block active">Enviar</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" th:inline="none">
    var dataReq = {
        venta: {},
        detalleVenta: [],
        productSelected : {},
        mesaList:[],
        productoList:[],
        cartillaDiariaList: []
    }
	function calcularCambio(){
		let totalPagado = $('#totalPagado').val();
    	if(!totalPagado){
    		totalPagado = 0;
    	}
    	let total = $('#total').val();
    	if(!total){
    		total = 0;
    	}
    	let cambio = totalPagado - total;
    	$('#totalCambio').val(cambio);
	}
    function imageExists(image_url){
        let http = new XMLHttpRequest();
        http.open('HEAD', image_url, false);
        http.send();
        return http.status != 404;

    }
    function btnMinProducto(productoId){
	    let can = $('#cantidad-'+productoId).val();
	    if(can) {
	        can = parseInt(can);
	        can--;
        } else {
	        can = 0;
        }
	    if(can < 0) {
	        can = 0;
        }
        $('#cantidad-'+productoId).val(can);
    }
    function btnMaxProducto(productoId){
        let can = $('#cantidad-'+productoId).val();
        let found = dataReq.productoList.find(it => it.productoId === productoId);
        if(can) {
            can = parseInt(can);
            can++;
        } else {
            can = 1;
        }
        if(can > found.cantidad) {
            can = found.cantidad;
            modalAlert('No existe la cantidad',(found.xproducto+', cantidad actual: '+found.cantidad),'error');
        }
        $('#cantidad-'+productoId).val(can);
    }
    function btnMinPlato(productoId){
        let can = $('#cantidadPlato-'+productoId).val();
        if(can) {
            can = parseInt(can);
            can--;
        } else {
            can = 0;
        }
        if(can < 0) {
            can = 0;
        }
        $('#cantidadPlato-'+productoId).val(can);
    }
    function btnMaxPlato(productoId){
        let can = $('#cantidadPlato-'+productoId).val();
        // let found = dataReq.productoList.find(it => it.productoId === productoId);
        if(can) {
            can = parseInt(can);
            can++;
        } else {
            can = 1;
        }
        // if(can > found.cantidad) {
        //     can = found.cantidad;
        //     modalAlert('No existe la cantidad',(found.xproducto+', cantidad actual: '+found.cantidad),'error');
        // }
        $('#cantidadPlato-'+productoId).val(can);
    }
    function radioTipoVentaProducto(productoId, tipo){
        let found = dataReq.productoList.find(it => it.productoId === productoId);
	    if(tipo === 1) {
	        $('#precio-'+productoId).html(found.pvUnit);
	        $('#cant-'+productoId).html('Cant. '+found.cantidad);
        } else {
	        let can = parseInt(found.cantidad / found.unidadPorCaja);
            $('#precio-'+productoId).html(found.pvCaja);
            $('#cant-'+productoId).html('Cant. '+can);
        }
    }
    function btnAdicionarProducto(productoId){
        let found = dataReq.productoList.find(it => it.productoId === productoId);
        let formItem = $('#areaProducto-'+productoId).formToJSON();
        let tipoVenta = parseInt(formItem['tipoVenta-'+productoId]);
        let cantidad = parseInt(formItem.can);
        $('#cantidad-'+productoId).val('');
        if(!formItem.can || (formItem.can && cantidad <= 0)) {
            modalAlert('Cantidad incorrecta', found.xproducto, 'info');
            return;
        }
        if(cantidad > found.cantidad) {
            modalAlert('Cantidad excesiva', 'No se cuenta con esa cantidad. Cantidad actual: '+found.cantidad, 'info');
            return;
        }
        let cantidadUnitaria = parseInt(formItem.can);
        let precio = found.pvUnit;
        if(tipoVenta === 2) {
            precio = found.pvCaja
            cantidadUnitaria = cantidad * found.unidadPorCaja;
        }

        //Verificar si no existe el producto en la lista
        let productoExistente = dataReq.detalleVenta.find(it=>it.productoId === productoId);
        if(productoExistente) { // producto existente
            dataReq.detalleVenta.forEach(it=> {
                let auxTotal = it.cantidadUnitaria + cantidadUnitaria;
                if(auxTotal > found.cantidad) {
                    modalAlert('Cantidad modificada en total: '+auxTotal, 'No se cuenta con esa cantidad. Cantidad actual en almacen: '+found.cantidad, 'info');
                    return;
                }
                if(it.productoId === productoId) {
                    if(it.tipoVenta === 2 && tipoVenta === 1) {
                        it.xtipoVenta = 'Unid.';
                        it.tipoVenta = tipoVenta;
                        it.cantidad = it.cantidadUnitaria;
                        it.precio = precio;
                    }
                    if(it.tipoVenta === 1 && tipoVenta == 2) {
                        cantidad = cantidadUnitaria;
                    }
                    it.cantidad += cantidad;
                    it.cantidadUnitaria += cantidadUnitaria;
                    it.total = UtilNumeros.roundMoney(it.cantidad * it.precio);

                }
            })
        } else { // Nuevo producto
            let subtotal = UtilNumeros.roundMoney(cantidad * precio);
            dataReq.detalleVenta.push({
                'productoId': productoId,
                'xproducto':found.xproducto,
                'cantidad': cantidad,
                'precio': precio,
                'total': subtotal,
                'tipoVenta': tipoVenta,
                'cantidadUnitaria': cantidadUnitaria,
                'xtipoVenta': tipoVenta === 1 ? 'Unid.': 'Caja'
            });
        }
        renderDetalleVenta();
    }
    function btnAdicionarPlato(cartillaSucursalId, cartillaDiariaId, detalleCartillaSucursalId, detalleCartillaDiariaId,productoId){
        dataReq.cartillaDiariaList.cartillaSucursalFormList.forEach(det => {
            if(det.id === cartillaSucursalId) {
                det.detalleCartillaList.forEach(subdet => {
                    if (subdet.id === detalleCartillaSucursalId) {
                        let found = subdet.productos.find(it => it.productoId === productoId);
                        let formItem = $('#areaPlato-'+cartillaDiariaId+'-'+detalleCartillaDiariaId).formToJSON();
                        let cantidad = parseInt(formItem.can);
                        $('#cantidadPlato-'+productoId).val('');
                        if(!formItem.can || (formItem.can && cantidad <= 0)) {
                            modalAlert('Cantidad incorrecta', found.xproducto, 'info');
                            return;
                        }
                        if(cantidad > found.cantidad) {
                            modalAlert('Cantidad excesiva', 'No se cuenta con esa cantidad. Cantidad actual: '+found.cantidad, 'info');
                            return;
                        }
                        let precio = found.precioIndividual;
                        //Verificar si no existe el producto en la lista
                        let productoExistente = dataReq.detalleVenta.find(it => it.productoId === productoId && it.cartillaSucursalId === cartillaSucursalId
                            && it.cartillaDiariaId === cartillaDiariaId && it.detalleCartillaDiariaId === detalleCartillaDiariaId);
                        if(productoExistente) { // producto existente
                            dataReq.detalleVenta.forEach(it=> {
                                if(it.productoId === productoId && it.cartillaSucursalId === cartillaSucursalId
                                    && it.cartillaDiariaId === cartillaDiariaId && it.detalleCartillaDiariaId === detalleCartillaDiariaId) {
                                    let auxTotal = it.cantidadUnitaria + cantidad;
                                    if(auxTotal > found.cantidadUnitaria) {
                                        modalAlert('Cantidad modificada en total: '+auxTotal, 'No se cuenta con esa cantidad. Cantidad actual en almacen: '+found.cantidad, 'info');
                                        return;
                                    }
                                    it.cantidad += cantidad;
                                    it.cantidadUnitaria += cantidad;
                                    it.total = UtilNumeros.roundMoney(it.cantidad * it.precio);
                                }
                            })
                        } else { // Nuevo producto
                            let subtotal = UtilNumeros.roundMoney(cantidad * precio);
                            dataReq.detalleVenta.push({
                                'productoId': productoId,
                                'xproducto':found.xproducto,
                                'cantidad': cantidad,
                                'precio': precio,
                                'total': subtotal,
                                'tipoVenta': 1,
                                'cantidadUnitaria': cantidad,
                                'xtipoVenta': 'Unid.',
                                'cartillaSucursalId':cartillaSucursalId,
                                'cartillaDiariaId': cartillaDiariaId,
                                'detalleCartillaSucursalId': detalleCartillaSucursalId,
                                'detalleCartillaDiariaId': detalleCartillaDiariaId,
                                'esCompuesto':false
                            });
                        }
                    }
                });
            }
        });
        renderDetalleVenta();
    }
    function renderDetalleVenta(){
	    $('#tablaDetalleVenta >tbody').html('');
        $('#tablaDetalleVenta >tfoot').html('');
        let total = 0;
	    if(dataReq.detalleVenta && dataReq.detalleVenta.length > 0) {
	        dataReq.detalleVenta.forEach(it => {
	            total += it.total;
	            let row = $('<tr></tr>');
	            $('<td>'+it.xproducto+'</td>').appendTo(row);
	            $('<td class="w3-center">'+it.cantidad+'</td>').appendTo(row);
	            $('<td class="w3-center">'+it.xtipoVenta+'</td>').appendTo(row);
	            $('<td class="w3-center">'+it.precio+'</td>').appendTo(row);
	            $('<td class="w3-center">'+it.total+'</td>').appendTo(row);
	            $('#tablaDetalleVenta > tbody:last').append(row);
            });
        } else {
            let row = $('<tr></tr>');
            $('<td class="w3-center" colspan="5">Sin detalles</td>').appendTo(row);
            $('<td class="w3-right-align custom-bolder" colspan="3">'+UtilNumeros.roundMoney(total)+'</td>').appendTo(row);
        }
        let row = $('<tr></tr>');
        $('<td colspan="3" style="padding-top: 50px">SON: '+numeroALetras(total)+'</td>').appendTo(row);
        $('<td class="w3-right-align custom-bolder" colspan="3" style="padding-top: 50px">'+UtilNumeros.roundMoney(total)+'</td>').appendTo(row);
        $('#tablaDetalleVenta > tfoot').append(row);
    }
    function btnAdicionarCompuesto(id){
        dataReq.cartillaDiariaList.cartillaSucursalFormList.forEach(det => {
            if(det.id === id) {
                let row = $('<div class="row"></div>');
                $('<div class="col-md-6"><span class="custom-bolder h4">'+ det.nombre +'</span> <span class="custom-bolder h5 text-muted">Bs. '+ det.total +'</span></div>').appendTo(row);
                $('<div class="col-md-2 custom-bolder">Cantidad</div>').appendTo(row);
                $('<div class="col-md-4 custom-bolder text-center">Acciones</div>').appendTo(row);
                det.detalleCartillaList.forEach(subdet => {
                    $('<div class="col-md-12 custom-bolder padding-left-lg">'+ subdet.xtipoProducto +'</div>').appendTo(row);
                    if(subdet.productos && subdet.productos.length > 0) {
                        subdet.productos.forEach(item => {
                            $('<div class="col-md-6 padding-left-xl margin-top-lg">' + item.xproducto + '</div>').appendTo(row);
                            $('<div class="col-md-2 margin-top-lg"><input type="text" size="8" class="w3-tiny" name="detalleCantidadCompuesta" /></div>').appendTo(row);
                            $('<div class="col-md-4 margin-top-lg text-center"><button class="btn btn-xs btn-danger" style="margin-right: 15px;" onclick="disminuirSubdetalle('+item.cartillaDiariaId+','+item.cartillaSucursalId+','+item.id+')" type="button"><i class="fa fa-minus"></i></button><button class="btn btn-xs btn-success" onclick="disminuirSubdetalle('+item.cartillaDiariaId+','+item.cartillaSucursalId+','+item.id+')" type="button"><i class="fa fa-plus"></i></button></div>').appendTo(row);
                        })
                    } else {
                        $('<div class="text-center">Sin detalles</div>')
                    }
                });
                $('<div class="col-md-12"><hr/></div>').appendTo(row);
                $('#contenidoCartilla').append(row);
            }
        });
        $('#modalCompuesto').modal('show');
    }
	function init(){
	    $('#areaMesa').html('');
        $('#areaProducto').html('');
	    $.post('../venta/initParam', function(resp){
	        if(resp.status) {
	            dataReq.mesaList = resp.data.mesas;
	            dataReq.productoList = resp.data.productos;
	            dataReq.cartillaDiariaList = resp.data.cartillaDiariaList;
	            if(resp.data.mesas && resp.data.mesas.length > 0) {
	                resp.data.mesas.forEach(it => {
	                    let divCol = $('<div class="col-md-2"></div>');
	                    let divInfoBox = $('<div class="info-box"></div>');
	                    $('<span class="info-box-icon bg-aqua"><input type="radio" class="w3-radio" name="mesaId" value="'+it.id+'"/></span>').appendTo(divInfoBox);
	                    let divContent = $('<div class="info-box-content"></div>');
	                    $('<span class="info-box-number">'+it.alias+'</span>').appendTo(divContent);
                        $('<span class="info-box-text">'+it.nombre+'</span>').appendTo(divContent);
                        $('<span class="info-box-more">Cantidad: '+it.cantidad+' </span>').appendTo(divContent);
                        divInfoBox.append(divContent);
                        divCol.append(divInfoBox);
                        $('#areaMesa').append(divCol);
                    })
                }
	            if(resp.data.productos && resp.data.productos.length > 0) {
	                resp.data.productos.forEach(it => {
	                    let div1 = $('<div class="col-md-4 item" id="areaProducto-'+it.productoId+'"></div>');
	                    if(imageExists('/producto/'+it.foto)) {
                            $('<div class="plato-img"><img src="/producto/'+it.foto+'" alt="Product Image"></div>').appendTo(div1);
                        } else {
                            $('<div class="plato-img"><img src="/producto/notimage.png" alt="Product Image"></div>').appendTo(div1);
                        }
	                    let div2 = $('<div class="plato-info"></div>');
	                    $('<a href="#" class="plato-title">Bs. <span id="precio-'+it.productoId+'">'+it.pvUnit+'</span> <span class="label label-warning pull-right w3-small" id="cant-'+it.productoId+'">Stock: '+it.cantidad+'</span></a>').appendTo(div2);
	                    $('<span class="plato-description">'+it.xproducto+'</span>').appendTo(div2);
	                    div1.append(div2);
	                    let div3 = $('<span class="plato-description"></span>');
                        $('<input type="text" class="w3-medium" style="width: 50%;" id="cantidad-'+it.productoId+'" name="can"/><input type="hidden" name="productoId" value="'+it.productoId+'"/>').appendTo(div3);
                        $('<button onclick="btnMinProducto('+it.productoId+')" class="btn btn-xs btn-danger" style="margin-left: 10px;margin-right: 5px;"><span class="fa fa-minus"></span></button>').appendTo(div3);
                        $('<button onclick="btnMaxProducto('+it.productoId+')" class="btn btn-xs btn-success" style="margin-left: 5px;margin-right: 10px;"><span class="fa fa-plus"></span></button>').appendTo(div3);
                        let div4 = $('<span class="plato-description"></span>');
                        let div5 = $('<div class="radio"></div>');
                        $('<label style="margin-right: 10px;"><input type="radio" onchange="radioTipoVentaProducto('+it.productoId+',1)" name="tipoVenta-'+it.productoId+'" value="1" checked> Unidad </label>').appendTo(div5);
                        $('<label><input type="radio" onchange="radioTipoVentaProducto('+it.productoId+',2)" name="tipoVenta-'+it.productoId+'" value="2" > Caja</label>').appendTo(div5);
                        $('<span class="pull-right"><button onclick="btnAdicionarProducto('+it.productoId+')" class="btn btn-xs btn-primary">OK</button></span>').appendTo(div5);
                        div4.append(div5);
                        div1.append(div3);
                        div1.append(div4);
                        $('#areaProducto').append(div1);
                    });
                }
	            if(resp.data.cartillaDiariaList) {
                    let auxCartilla = resp.data.cartillaDiariaList.cartillaSucursalFormList;
                    auxCartilla.forEach(it => {
                        $('#tabCartilla').append($('<li><a href="#tab_'+it.id+'" data-toggle="tab">'+it.nombre+'</a></li>'));
                        let divContent = $('<div class="tab-pane" id="tab_'+it.id+'"></div>');
                        if(it.estaCompuesto) {
                            let formCompuesto = $('<div class="row"></div>');
                            $('<div class="col-md-4">'+it.nombre+'</div>').appendTo(formCompuesto);
                            $('<div class="col-md-2"><div class="form-group"><input type="text" placeholder="Cantidad" class="form-control" name="cantidadCompuesto-'+it.id+'"></div></div>').appendTo(formCompuesto);
                            $('<div class="col-md-2"><button class="btn btn-success btn-block" type="button" onclick="btnAdicionarCompuesto('+it.id+')"> Adicionar</button></div>').appendTo(formCompuesto);
                            formCompuesto.appendTo(divContent);
                            $('<h3>'+it.nombre+'</h3>').appendTo(divContent);
                            it.detalleCartillaList.forEach(itDetalleCartilla => {
                                $('<h3>'+itDetalleCartilla.xtipoProducto+'</h3>').appendTo(divContent);
                                let divRow = $('<div class="row platos-list plato-list-in-box"></div>');
                                itDetalleCartilla.productos.forEach(itProducto => {
                                    divRow.append(generateColumnPlato(itProducto));
                                });
                                divContent.append(divRow);
                            });
                        } else {
                            let divRow = $('<div class="row platos-list plato-list-in-box"></div>');
                            it.detalleCartillaList[0].productos.forEach(itProducto => {
                                divRow.append(generateColumnPlato(itProducto));
                            });
                            divContent.append(divRow);
                        }
                        $('#tabContentCartilla').append(divContent);
                    })
                } else {
	                modalAlert('Sin cartilla de preparaciones', 'Contactarse con administracion', 'info');
                }
            }
        })
    }
    function generateColumnPlato(itProducto){
        let div1 = $('<div class="col-md-4 item" id="areaPlato-'+itProducto.cartillaDiariaId+'-'+itProducto.id+'"></div>');
        if(imageExists('/producto/'+itProducto.foto)) {
            $('<div class="plato-img"><img src="/producto/'+itProducto.foto+'" alt="Product Image"></div>').appendTo(div1);
        } else {
            $('<div class="plato-img"><img src="/producto/notimage.png" alt="Product Image"></div>').appendTo(div1);
        }
        let div2 = $('<div class="plato-info"></div>');
        $('<a href="#" class="plato-title">Bs. <span id="precioPlato-'+itProducto.id+'">'+itProducto.precioIndividual+'</span> <span class="label label-warning pull-right w3-small" id="cantPlato-'+itProducto.id+'">Stock: '+itProducto.cantidad+'</span></a>').appendTo(div2);
        $('<span class="plato-description">'+itProducto.xproducto+'</span>').appendTo(div2);
        div1.append(div2);
        let div3 = $('<span class="plato-description"></span>');
        $('<input type="text" class="w3-medium" style="width: 50%;" id="cantidadPlato-'+itProducto.id+'" name="can"/>').appendTo(div3);
        $('<button onclick="btnMinPlato('+itProducto.id+')" class="btn btn-xs btn-danger" style="margin-left: 10px;margin-right: 5px;"><span class="fa fa-minus"></span></button>').appendTo(div3);
        $('<button onclick="btnMaxPlato('+itProducto.id+')" class="btn btn-xs btn-success" style="margin-left: 5px;margin-right: 10px;"><span class="fa fa-plus"></span></button>').appendTo(div3);
        let div4 = $('<span class="plato-description"></span>');
        $('<span class="pull-right"><button onclick="btnAdicionarPlato('+itProducto.cartillaSucursalId+','+itProducto.cartillaDiariaId+','+itProducto.detalleCartillaSucursalId+','+itProducto.id+','+itProducto.productoId+')" class="btn btn-xs btn-primary">OK</button></span>').appendTo(div4);
        div1.append(div3);
        div1.append(div4);
        return div1;
    }
    $(document).ready(function() {
        $('#totalPagado').keyup(function(){
        	calcularCambio();
        });
        // Toolbar extra buttons
        const btnCancel = $('<button></button>').html('<i class="fa fa-times-circle"></i><br/>Salir Venta')
            .addClass('btn w3-red w3-border-red')
            .on('click', function(){
                alertCancelacion('Cancelar venta', 'Esta seguro de cancelar la venta', function () {
                    $.post('../venta/gestion', function (resp) {
                        $("#contenedor").html(resp);
                    });
                })
            });
        // Step show event
        $("#smartwizard").on("showStep", function(e, anchorObject, stepNumber, stepDirection, stepPosition) {
            $("#prev-btn").removeClass('disabled');
            $("#next-btn").removeClass('disabled');
            if(stepPosition === 'first') {
                $("#prev-btn").addClass('disabled');
            } else if(stepPosition === 'last') {
                $("#next-btn").addClass('disabled');
            } else {
                $("#prev-btn").removeClass('disabled');
                $("#next-btn").removeClass('disabled');
            }
        });

        // Smart Wizard
        $('#smartwizard').smartWizard({
            selected: 0,
            theme: 'arrows', // default, arrows, dots, progress
            //darkMode: true,
            transition: {
                animation: 'slide-horizontal', // Effect on navigation, none/fade/slide-horizontal/slide-vertical/slide-swing
            },
            toolbarSettings: {
                toolbarPosition: 'bottom', // both bottom
                toolbarExtraButtons: [btnCancel],
                toolbarButtonPosition: 'center'
            },
            lang: {
                next: 'Siguiente',
                previous: 'Volver atras'
            }
        });

        // External Button Events
        $("#reset-btn").on("click", function() {
            $('#smartwizard').smartWizard("reset");
            return true;
        });

        $("#prev-btn").on("click", function() {
            $('#smartwizard').smartWizard("prev");
            return true;
        });

        $("#next-btn").on("click", function() {
            $('#smartwizard').smartWizard("next");
            return true;
        });
        $('.sw-btn-next').html('<i class="fa fa-arrow-circle-right"></i><br>Siguiente');
        $('.sw-btn-prev').html('<i class="fa fa-arrow-circle-left"></i><br>Volver atras');
        $('#smartwizard').smartWizard("goToStep", 0);
        $('#formulario1').formValidation({
            locale: 'es_ES',
            excluded: ':disabled',
            fields: {
                cliente: {
                    validators: {
                        notEmpty: {
                            message: 'Por favor seleccione un producto'
                        }
                    }
                }
            }
        }).on('success.field.fv', function(e, data) {
            var estadoForm1 = $('#formulario1').data('formValidation').isValid();
            if (estadoForm1)
                $('#guardar').removeAttr('disabled');
        }).on('err.field.fv.', function(e, data) {
            $('#guardar').attr('disabled', 'disabled');
        });

        $('#formulario3').formValidation({
            locale: 'es_ES'
        }).on('success.fv.field', '[name="desVen"]', function() {
        	calculoTotal();
        }).on('success.fv.field', '[name="descuentos"]', function() {
            calculoTotal();
        }).on('success.fv.field', function() {
            var estadoForm3 = $('#formulario3').data('formValidation').isValid();
            if (estadoForm3) {
                calculoTotal();
            }
        }).on('err.field.fv', function(e) {
            e.preventDefault();
            var xform = $(e.target);
            $('#total-final').html('');
        }).on('success.form.fv', function(e) {
            e.preventDefault();
            let xform = $(e.target);
            let formapago = parseInt($('input[name=formapago]:checked').val());
            if(formapago == 1){
            	let codSubcuenta = $('#codSubcuenta option:selected').val();
            	if(codSubcuenta == ''){
            		modalAlert('Validacion incorrecta', 'Seleccione una cuenta bancaria, si la forma de pago es por deposito bancario','error');
            		return;
            	}
            }
            alertAdicion('Confirmacion de registro de venta', 'Esta seguro de realizar esta venta?', function(){
            	$('#formulario1').data('formValidation').validate();
                var estadoForm1 = $('#formulario1').data('formValidation').isValid();
                if ($('#total').val() > 0) {
                    if (estadoForm1 != null)
                        if (estadoForm1) {
                            try {
                                abrirLoad();
                                $.post(xform.attr('action'), $('#formulario1').serialize() + '&' + $('#formulario4').serialize() + '&' + xform.serialize(), function(result) {
                                    cerrarLoad();
                                    if (result.status) {
                                        xform.data('formValidation').resetForm();
                                        $.post('../venta/gestion', function(respuno) {
                                            mostrarMensaje('info', 'Se realizo con exito la Transaccion.');
                                            $('#contenedor').html(respuno);
                                        });
                                    } else {
                                        mostrarMensaje('error', 'No se realizo con exito la transaccion.');
                                    }
                                }, 'json');
                            } catch (e) {
                                console.log('Error al adicionar venta: ',e);
                                cerrarLoad();
                            } finally {
                                cerrarLoad();
                            }
                        }
                } else {
                    $('#formulario1').data('formValidation').validate();
                    mostrarMensaje('error', 'Valide los campos requeridos.');
                    mostrarMensaje('error', 'Por favor ingrese el detalle.');
                }
            });
        });
        $('#adicionarCliente').click(function() {
            $('#formularioCliente').data('formValidation').resetForm();
            $('#formularioCliente')[0].reset();
            $('#codigo').val(0);
            $('#modalCliente').modal('show');
        });
        $('#obtenerProducto').click(function() {
            $('#formularioBarCode').data('formValidation').resetForm();
            $('#formularioBarCode')[0].reset();
            $('#modalBarCode').modal('show');
        });
        $('#formularioCliente').formValidation({
            locale: 'es_ES'
        }).on('success.form.fv', function(e) {
            e.preventDefault();
            var xform = $(e.target);
            alertAdicion('Registro de cliente', 'Esta seguro de registrar este cliente?', function(){
            	$.post(xform.attr('action'), xform.serialize(), function(result) {
                    if (result.status == true) {
                        xform.data('formValidation').resetForm();
                        $('#cliente').append($('<option>', {
                            value: result.codCli,
                            text: result.cliente
                        }));
                        $('#cliente option[value=' + result.codCli + ']').attr('selected', 'selected');
                        $('#cliente').trigger('chosen:updated');
                        $('.modal').modal('hide');

                        mostrarMensaje('info', 'Se realizo con exito la Transaccion');
                    } else {
                        mostrarMensaje('error', 'No se realizo con exito la Transaccion');
                    }
                }, 'json');
            })
        });
        init();
    });

    function buscarCodigo() {
        if ($('#barcode').val() != '')
            $.post('../producto/obtenerxcodigo?barcode=' + $('#barcode').val(), function(resp) {
                if (resp.status) {
                    if (resp.data.can_pro > 0) {
                        $('#can1').val(1);
                        $('#pre1').val(resp.data.preven_pro);
                        $('#tot1').val(resp.data.preven_pro);
                        $('#adicionar').click();
                        mostrarMensaje('info', 'Se realizo con exito la Transaccion');
                    } else
                        mostrarMensaje('info', 'Se acabo la cantidad de este producto.');
                } else {
                    mostrarMensaje('error', 'No se encontro producto con este numero de codigo.');
                }
                $('#barcode').val('');
            }, 'json');
    }
    function calculoTotal() {
        let subtot = 0;
        let des = 0;
        let tot = 0;
        $('.input-subtot').each(function() {
            subtot += parseFloat($(this).val());
        });
        
        $('.input-des').each(function() {
            des += parseFloat($(this).val());
        });
        $('.input-tot').each(function() {
            tot += parseFloat($(this).val());
        });
        $("#subtotal").val(subtot.toFixed(2));
        $("#subdescuento").val(des.toFixed(2));
        $("#subtotal-descuento").val(tot.toFixed(2));
        let descuentoTotal = parseFloat($('#descuento').val());
        let totalGeneral = tot - descuentoTotal;
        $('#total').val(totalGeneral.toFixed(2));
        calcularCambio();
    }

    function calcularSubtotal(valor) {
        let cantidad = $('#can-' + valor).val();
        let precio = $('#pre-' + valor).val();
        let descuento = $('#des-' + valor).val();
        if(!cantidad){
        	cantidad = 0
        }
        if(!precio){
        	precio = 0;
        }
        if(!descuento){
        	descuento = 0;
        }
        let subtotal = parseFloat(precio) * parseFloat(cantidad);
        let total = subtotal - parseFloat(descuento);
        $('#subtot-' + valor).val(subtotal.toFixed(2));
        $('#tot-'+valor).val(total.toFixed(2));
        calculoTotal();
    }

</script>
</section>