<style type="text/css">
    .toolbar{
        position: fixed;
        bottom: 0;
        width: 100%;
        padding-bottom: 0px !important;

    }
    div.toolbar .toolbar-bottom {
        text-align:right !important;
        padding-right: 350px;
        margin-bottom:50px;
    }
</style>
<section xmlns:th="http://www.thymeleaf.org">
<form id="formularioCliente" method="post" action="../cliente/guardar" data-fv-framework="bootstrap" data-fv-excluded="disabled" data-fv-icon-valid="glyphicon glyphicon-ok" data-fv-icon-invalid="glyphicon glyphicon-remove" data-fv-icon-validating="glyphicon glyphicon-refresh">
    <div id="modalCliente" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Adicionar Cliente</h4>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="codigo" name="cod_per">
                    <input type="hidden" name="ci_per" value="0">
                    <input type="hidden" name="dir_per" value="">
                    <input type="hidden" name="segape_per" value="">
                    <input type="hidden" name="fot_per" value="user.png">
                    <div class="form-group">
                    	<label>Celular.</label>
                    	<input type="text" class="form-control text-right" id="tel_per" name="tel_per">
                    </div>
                    <div class="form-group">
                    	<label>Nombre</label>
                    	<input type="text" class="form-control text-uppercase" id="nom_per" name="nom_per" data-fv-notempty="true">
                    </div>
                    <div class="form-group">
                    	<label>Apellidos</label>
                    	<input type="text" class="form-control text-uppercase" id="priape_per" name="priape_per" data-fv-notempty="true">
                    </div>
                    <div class="form-group">
                    	<label>Genero</label>
                    	<div class="radio">
                    		<label for="masculino"><input type="radio" id="masculino" name="sex_per" value="true" data-fv-notempty="true"/>Masculino</label>
                    		<label for="femenino"><input type="radio"  id="femenino" name="sex_per" value="false" data-fv-notempty="true"/>Femenino</label>
                    	</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-social btn-google" data-dismiss="modal"><i class="glyphicon glyphicon-remove-sign"></i> Cancelar</button>
                    <button type="submit" id="btnAdicionarConfirmacion" class="btn btn-social btn-bitbucket"><i class="glyphicon glyphicon-floppy-disk"></i> Guardar</button>
                </div>
            </div>
        </div>
    </div>
</form>
    <form id="formularioCompuesto" method="post" action="#" data-backdrop="static" data-fv-framework="bootstrap" data-fv-excluded="disabled" data-fv-icon-valid="glyphicon glyphicon-ok" data-fv-icon-invalid="glyphicon glyphicon-remove" data-fv-icon-validating="glyphicon glyphicon-refresh">
        <div id="modalCompuesto" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Registrar</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-4 text-right">
                                <label class="control-label">Cantidad solicitada</label>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <div class="input-group">
                                        <span class="input-group-addon"><i class="fa fa-cubes"></i></span>
                                        <input type="text" class="form-control text-right" autocomplete="off" name="cantidadCompuesto" id="cantidadCompuesto" data-fv-integer="true" data-fv-notempty="true" />
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-danger" type="button" onclick="btnCompuestoGeneral(false)"><i class="fa fa-minus"></i></button>
                                <button class="btn btn-success" type="button" onclick="btnCompuestoGeneral(true)"><i class="fa fa-plus"></i></button>
                            </div>
                        </div>
                        <hr/>
                        <div id="contenidoCartilla"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-social btn-google" data-dismiss="modal"><i class="glyphicon glyphicon-remove-sign"></i> Cancelar</button>
                        <button type="submit" id="btnSubmitSubdetalle" class="btn btn-social btn-bitbucket"><i class="glyphicon glyphicon-floppy-disk"></i> Guardar</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <div id="modalGestionCliente" class="modal fade">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Clientes del sistema</h4>
                </div>
                <div class="modal-body">
                    <table id="tablaCliente" class="table table-striped table-bordered dt-responsive" cellspacing="0" width="100%">
                        <thead>
                        <tr>
                            <th class="none">C&oacute;digo de cliente</th>
                            <th class="desktop">Telefono celular</th>
                            <th class="all">Nombre y Apellidos</th>
                            <th width="200px" class="all">Acciones</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-social btn-google" data-dismiss="modal"><i class="glyphicon glyphicon-remove-sign"></i> Cerrar</button>
                </div>
            </div>
        </div>
    </div>

<div id="smartwizard">
    <ul class="nav" style="display: none;">
        <li class="nav-item">
            <a class="nav-link" href="#step-1">
                <strong>1</strong>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#step-2">
                <strong>Step 2</strong>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#step-3">
                <strong>Step 3</strong>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link " href="#step-4">
                <strong>Step 4</strong>
            </a>
        </li>
    </ul>

    <div class="tab-content" >
        <div style="height: 100vh !important;" id="step-1" class="tab-pane" role="tabpanel" aria-labelledby="step-1">
            <form id="formulario1" name="formulario1" action="#" method="post" data-fv-framework="bootstrap" data-fv-icon-valid="glyphicon glyphicon-ok" data-fv-icon-invalid="glyphicon glyphicon-remove" data-fv-icon-validating="glyphicon glyphicon-refresh">
                <div  class="panel panel-primary">
                    <div class="panel-heading">
                        <h5 class="w3-center">Registro de Venta </h5>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <input type="hidden" name="usuarioId" />
                                    <label>Mesero</label>
                                    <select class="form-control select-chosen" name="usuarioId" id="usuarioId" data-fv-notempty="true">
                                        <option value="">Seleccionar</option>
                                        <option th:each="m : ${meseros}" th:text="${m.nom_per + ' ' + m.priape_per}" th:value="${m.cod_per}"></option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Cliente</label>
                                    <a href="#" class="form-control" id="btnCliente"><i class="fa fa-user-secret"></i> <span id="xcliente">Cliente Incognito</span></a>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-sm btn-success form-control" title="Adicionar Cliente" id="adicionarCliente"> <span class="glyphicon glyphicon-plus"></span> Cliente Nuevo</button>
                            </div>
                        </div>
                        <h4 class="content-header">Mesa</h4>
                        <div class="row" id="areaMesa"></div>
                        <br><br><br><br><br>
                    </div>
                </div>
            </form>
        </div>
        <div id="step-2" class="tab-pane" role="tabpanel" aria-labelledby="step-2">
            <h5>Productos</h5>
            <div class="row">
                <div class="col-md-3">
                    <table class="w3-table-all w3-card-4" id="tablaDetalleVenta">
                        <thead>
                        <tr>
                            <th>Detalle</th>
                            <th width="20px">Cant.</th>
                            <th width="20px">Medida</th>
                            <th width="20px">Precio</th>
                            <th width="20px">Subtotal</th>
                        </tr>
                        </thead>
                        <tbody>
                        <td colspan="5" class="w3-center">Sin ningun detalle</td>
                        </tbody>
                        <tfoot></tfoot>
                    </table>
                </div>
                <div class="col-md-9">
                    <div class="nav-tabs-custom">
                        <ul class="nav nav-tabs" id="tabCartilla">
                            <li class="active"><a href="#tab_0" data-toggle="tab">Productos</a></li>
                        </ul>
                        <div class="tab-content" id="tabContentCartilla">
                            <div class="tab-pane active" id="tab_0">
                                <div class="row platos-list plato-list-in-box" style="height: 800px;" id="areaProducto"></div>
                            </div><!-- /.tab-pane -->
                        </div><!-- /.tab-content -->
                    </div>
                </div>
            </div>
        </div>
        <div id="step-3" class="tab-pane" role="tabpanel" aria-labelledby="step-3">
            <form id="formulario3" name="formulario3" action="#" method="post" data-fv-framework="bootstrap" data-fv-icon-valid="glyphicon glyphicon-ok" data-fv-icon-invalid="glyphicon glyphicon-remove" data-fv-icon-validating="glyphicon glyphicon-refresh">
                <div class="panel panel-primary">
                    <div class="panel-body">
                        <div class="row" id="areaResumenVenta">
                            <div class="col-md-6">
                                <div class="small-box bg-aqua">
                                    <div class="inner">
                                        <h3><span aria-label="xcliente">Carlos Franz Gutierrez</span></h3>
                                        <p>Cliente</p>
                                    </div>
                                    <div class="icon">
                                        <i class="ion ion-person-add"></i>
                                    </div>
                                    <a href="#" class="small-box-footer" onclick="volverPasoInicial()">Modificar <i class="fa fa-arrow-circle-right"></i></a>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="small-box bg-aqua">
                                    <div class="inner">
                                        <h3><span aria-label="xmesa">Mesa 4</span></h3>
                                        <p>No. personas: <span aria-label="xcantidadPersonas">5</span></p>
                                    </div>
                                    <div class="icon">
                                        <i class="fa fa-street-view"></i>
                                    </div>
                                    <a href="#" class="small-box-footer" onclick="volverPasoInicial()">Modificar <i class="fa fa-arrow-circle-right"></i></a>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="small-box bg-aqua">
                                    <div class="inner">
                                        <h3><span aria-label="xmesero">CGutierrez</span></h3>
                                        <p>Mesero</p>
                                    </div>
                                    <div class="icon">
                                        <i class="fa fa-user"></i>
                                    </div>
                                    <a href="#" class="small-box-footer" onclick="volverPasoInicial()">Modificar <i class="fa fa-arrow-circle-right"></i></a>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="areaResumenDetalleVenta" class="w3-table-all w3-large">
                                <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th width="10%" class="w3-center">Cantidad</th>
                                    <th width="10%" class="w3-center"> Precio </th>
                                    <th width="10%" class="w3-center">Total</th>
                                    <th width="10%" class="w3-center">Observacion</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr id="unit">
                                    <td colspan="7" class="w3-center">Sin ningun detalle</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <br>
                        <div class="form-group row">
                            <label class="control-label col-md-1">Observaciones</label>
                            <div class="col-md-11">
                                <textarea name="obsGeneral" id="obsGeneral" class="form-control input-sm" rows="5" placeholder="Ingrese observaciones, si es necesario"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="panel-footer text-right">
                        <button class="btn btn-primary" type="submit"><i class="fa fa-save"></i> Guardar Comanda</button>
                    </div>
                </div>
            </form>
        </div>
        <div id="step-4" class="tab-pane" role="tabpanel" aria-labelledby="step-4">
            <form id="formulario4" name="formulario4" action="../venta/finalizarComanda" method="post">
            <div class="panel panel-primary">
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-8">
                            <table id="areaDetalleInfo" class="w3-table-all w3-small">
                                <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th width="10%" class="w3-center">Cantidad</th>
                                    <th width="10%" class="w3-center"> Precio </th>
                                    <th width="10%" class="w3-center">Total</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td colspan="4" class="w3-center">Sin ningun detalle</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-4">
                            <div class="table-responsive">
                                <table class="w3-table w3-small">
                                    <thead>
                                    <tr>
                                        <th colspan="6" class="w3-center">Resumen de venta</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr class="w3-right-align">
                                        <td colspan="4"  class="w3-right-align">Total</td>
                                        <td colspan="2">
                                            <input type="text" id="subtotalVenta" class="form-control input-xs text-right" readonly="readonly" name="subtotal" value="0">
                                        </td>
                                    </tr>
                                    <tr  class="w3-right-align">
                                        <td colspan="4" class="w3-right-align">Descuento</td>
                                        <td colspan="2"  class="w3-right-align">
                                            <input type="text" id="descuentoVenta" name="descuento" min="0" onkeyup="setDescuento()" class="form-control input-xs text-right" data-fv-numeric="true" data-fv-numeric-decimalseparator="." value="0" data-fv-notempty="true" onClick="this.setSelectionRange(0, this.value.length)">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" class="w3-right-align">Total a Pagar</td>
                                        <td colspan="2">
                                            <input type="text" class="form-control input-xs text-right" readonly="readonly" name="total" value="0">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="6" class="custom-bolder" aria-label="totalLiteral"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" class="w3-right-align">Forma de pago</td>
                                        <td colspan="2">
                                            <div class="form-group">
                                                <select name="formaPagoId" class="form-control input-xs" data-fv-notempty="true">
                                                    <option value="">Seleccionar</option>
                                                    <option th:each="f : ${formas}" th:value="${f.id}" th:text="${f.nombre}"></option>
                                                </select>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" class="w3-right-align">Total Pagado</td>
                                        <td colspan="2">
                                            <div class="form-group">
                                                <input type="text" class="form-control input-xs text-right" onkeyup="setTotalPagado()" id="totalPagado" name="totalPagado" data-fv-notempty="true" data-fv-numeric="true" data-fv-numeric-decimalseparator="." onClick="this.setSelectionRange(0, this.value.length)"/>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" class="w3-right-align">Cambio a entregar</td>
                                        <td colspan="2">
                                            <div class="form-group">
                                                <input type="text" class="form-control input-xs text-right" id="totalCambio" name="totalCambio" readonly="readonly"/>
                                            </div>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel-footer">
                    <button type="submit" id="guardar" class="btn btn-primary btn-block active">Guardar y Finalizar Comanda</button>
                </div>
            </div>
            </form>
        </div>
    </div>
</div>
<script type="text/javascript" th:inline="none">
    var dataReq = {
        venta: {},
        detalleVenta: [],
        detalleVentaCompuesto: [],
        productSelected : {},
        mesaList:[],
        productoList:[],
        cartillaDiariaList: [],
        detalleAux : {
            subdetalleAux: []
        }
    }
    function volverPasoInicial() {
        $('#smartwizard').smartWizard("goToStep", 0);
    }
    function imageExists(image_url){
        let http = new XMLHttpRequest();
        http.open('HEAD', image_url, false);
        http.send();
        return http.status != 404;

    }
    function btnMinProducto(productoId){
	    let can = $('#cantidad-'+productoId).val();
	    if(can) {
	        can = parseInt(can);
	        can--;
        } else {
	        can = 0;
        }
	    if(can < 0) {
	        can = 0;
        }
        $('#cantidad-'+productoId).val(can);
    }
    function btnCompuestoGeneral(state){
        let can = $('#cantidadCompuesto').val();
        if(!can) {
            can = 0;
        }
        if(state) {
            can++;
        } else {
            if(can > 0) {
                can--;
            }
        }
        $('#cantidadCompuesto').val(can);
    }
    function btnMaxProducto(productoId){
        let can = $('#cantidad-'+productoId).val();
        let found = dataReq.productoList.find(it => it.productoId === productoId);
        if(can) {
            can = parseInt(can);
            can++;
        } else {
            can = 1;
        }
        if(can > found.cantidad) {
            can = found.cantidad;
            modalAlert('No existe la cantidad',(found.xproducto+', cantidad actual: '+found.cantidad),'error');
        }
        $('#cantidad-'+productoId).val(can);
    }
    function btnMinPlato(productoId){
        let can = $('#cantidadPlato-'+productoId).val();
        if(can) {
            can = parseInt(can);
            can--;
        } else {
            can = 0;
        }
        if(can < 0) {
            can = 0;
        }
        $('#cantidadPlato-'+productoId).val(can);
    }
    function btnMaxPlato(productoId){
        let can = $('#cantidadPlato-'+productoId).val();
        if(can) {
            can = parseInt(can);
            can++;
        } else {
            can = 1;
        }
        $('#cantidadPlato-'+productoId).val(can);
    }
    function radioTipoVentaProducto(productoId, tipo){
        let found = dataReq.productoList.find(it => it.productoId === productoId);
	    if(tipo === 1) {
	        $('#precio-'+productoId).html(found.pvUnit);
	        $('#cant-'+productoId).html('Cant. '+found.cantidad);
        } else {
	        let can = parseInt(found.cantidad / found.unidadPorCaja);
            $('#precio-'+productoId).html(found.pvCaja);
            $('#cant-'+productoId).html('Cant. '+can);
        }
    }
    function btnAdicionarProducto(productoId){
        let found = dataReq.productoList.find(it => it.productoId === productoId);
        let formItem = $('#areaProducto-'+productoId).formToJSON();
        let tipoVenta = parseInt(formItem['tipoVenta-'+productoId]);
        let cantidad = parseInt(formItem.can);
        $('#cantidad-'+productoId).val('');
        if(!formItem.can || (formItem.can && cantidad <= 0)) {
            modalAlert('Cantidad incorrecta', found.xproducto, 'info');
            return;
        }
        if(cantidad > found.cantidad) {
            modalAlert('Cantidad excesiva', 'No se cuenta con esa cantidad. Cantidad actual: '+found.cantidad, 'info');
            return;
        }
        let cantidadUnitaria = parseInt(formItem.can);
        let precio = found.pvUnit;
        if(tipoVenta === 2) {
            precio = found.pvCaja
            cantidadUnitaria = cantidad * found.unidadPorCaja;
        }
        //Verificar si no existe el producto en la lista
        let productoExistente = dataReq.detalleVenta.find(it=>it.productoId === productoId);
        if(productoExistente) { // producto existente
            dataReq.detalleVenta.forEach(it=> {
                let auxTotal = it.cantidadUnitaria + cantidadUnitaria;
                if(auxTotal > found.cantidad) {
                    modalAlert('Cantidad modificada en total: '+auxTotal, 'No se cuenta con esa cantidad. Cantidad actual en almacen: '+found.cantidad, 'info');
                    return;
                }
                if(it.productoId === productoId) {
                    if(it.tipoVenta === 2 && tipoVenta === 1) {
                        it.xtipoVenta = 'Unid.';
                        it.tipoVenta = tipoVenta;
                        it.cantidad = it.cantidadUnitaria;
                        it.precio = precio;
                    }
                    if(it.tipoVenta === 1 && tipoVenta == 2) {
                        cantidad = cantidadUnitaria;
                    }
                    it.cantidad += cantidad;
                    it.cantidadUnitaria += cantidadUnitaria;
                    it.total = UtilNumeros.roundMoney(it.cantidad * it.precio);

                }
            })
        } else { // Nuevo producto
            let subtotal = UtilNumeros.roundMoney(cantidad * precio);
            dataReq.detalleVenta.push({
                'productoId': productoId,
                'xproducto':found.xproducto,
                'cantidad': cantidad,
                'precio': precio,
                'total': subtotal,
                'tipoVenta': tipoVenta,
                'cantidadUnitaria': cantidadUnitaria,
                'xtipoVenta': tipoVenta === 1 ? 'Unid.': 'Caja'
            });
        }
        renderDetalleVenta();
    }
    function btnAdicionarPlato(cartillaSucursalId, cartillaDiariaId, detalleCartillaSucursalId, detalleCartillaDiariaId,productoId){
        dataReq.cartillaDiariaList.cartillaSucursalFormList.forEach(det => {
            if(det.id === cartillaSucursalId) {
                det.detalleCartillaList.forEach(subdet => {
                    if (subdet.id === detalleCartillaSucursalId) {
                        let found = subdet.productos.find(it => it.productoId === productoId);
                        let formItem = $('#areaPlato-'+cartillaDiariaId+'-'+detalleCartillaDiariaId).formToJSON();
                        let cantidad = parseInt(formItem.can);
                        $('#cantidadPlato-'+productoId).val('');
                        if(!formItem.can || (formItem.can && cantidad <= 0)) {
                            modalAlert('Cantidad incorrecta', found.xproducto, 'info');
                            return;
                        }
                        if(cantidad > found.cantidad) {
                            modalAlert('Cantidad excesiva', 'No se cuenta con esa cantidad. Cantidad actual: '+found.cantidad, 'info');
                            return;
                        }
                        let precio = found.precioIndividual;
                        //Verificar si no existe el producto en la lista
                        let productoExistente = dataReq.detalleVenta.find(it => it.productoId === productoId && it.cartillaSucursalId === cartillaSucursalId
                            && it.cartillaDiariaId === cartillaDiariaId && it.detalleCartillaDiariaId === detalleCartillaDiariaId);
                        if(productoExistente) { // producto existente
                            dataReq.detalleVenta.forEach(it=> {
                                if(it.productoId === productoId && it.cartillaSucursalId === cartillaSucursalId
                                    && it.cartillaDiariaId === cartillaDiariaId && it.detalleCartillaDiariaId === detalleCartillaDiariaId) {
                                    let auxTotal = it.cantidadUnitaria + cantidad;
                                    if(auxTotal > found.cantidadUnitaria) {
                                        modalAlert('Cantidad modificada en total: '+auxTotal, 'No se cuenta con esa cantidad. Cantidad actual en almacen: '+found.cantidad, 'info');
                                        return;
                                    }
                                    it.cantidad += cantidad;
                                    it.cantidadUnitaria += cantidad;
                                    it.total = UtilNumeros.roundMoney(it.cantidad * it.precio);
                                }
                            })
                        } else { // Nuevo producto
                            let subtotal = UtilNumeros.roundMoney(cantidad * precio);
                            dataReq.detalleVenta.push({
                                'productoId': productoId,
                                'xproducto':found.xproducto,
                                'cantidad': cantidad,
                                'precio': precio,
                                'total': subtotal,
                                'tipoVenta': 1,
                                'cantidadUnitaria': cantidad,
                                'xtipoVenta': 'Unid.',
                                'cartillaSucursalId':cartillaSucursalId,
                                'cartillaDiariaId': cartillaDiariaId,
                                'detalleCartillaSucursalId': detalleCartillaSucursalId,
                                'detalleCartillaDiariaId': detalleCartillaDiariaId,
                                'esCompuesto':false
                            });
                        }
                    }
                });
            }
        });
        renderDetalleVenta();
    }
    function eliminarDetalleVenta(productoId, cartillaDiariaId, detalleCartillaDiariaId) {
        productoFound = dataReq.detalleVenta.find(it => it.productoId === productoId);
        alertEliminacion('Eliminar Detalle Venta', productoFound.xproducto, function(){
            dataReq.detalleVenta = dataReq.detalleVenta.filter( it => it.productoId !== productoId);
            if(cartillaDiariaId && detalleCartillaDiariaId) {
                dataReq.detalleVenta = dataReq.detalleVenta.filter(it => it.cartillaDiariaId === cartillaDiariaId && it.detalleCartillaDiariaId === detalleCartillaDiariaId);
            } else {
                dataReq.detalleVenta = dataReq.detalleVenta.filter(it => it.productoId === productoId);
            }
            renderDetalleVenta();
        });
    }
    function eliminarDetalleVentaCompuesto(id) {
        let productoFound = dataReq.detalleVentaCompuesto.find(it => it.id === id);
        alertEliminacion('Eliminar Detalle Venta', productoFound.nombre, function(){
            dataReq.detalleVentaCompuesto = dataReq.detalleVentaCompuesto.filter( it => it.id !== id);
            renderDetalleVenta();
        });
    }
    function renderDetalleVenta(){
	    $('#tablaDetalleVenta >tbody').html('');
        $('#tablaDetalleVenta >tfoot').html('');
        let total = 0;
	    if(dataReq.detalleVenta && dataReq.detalleVenta.length > 0) {
	        dataReq.detalleVenta.forEach(it => {
	            total += it.total;
	            let row = $('<tr></tr>');
	            $('<td>'+it.xproducto+'</td>').appendTo(row);
	            $('<td class="w3-center">'+it.cantidad+'</td>').appendTo(row);
	            $('<td class="w3-center">'+it.xtipoVenta+'</td>').appendTo(row);
	            $('<td class="w3-center">'+it.precio+'</td>').appendTo(row);
	            $('<td class="w3-center">'+it.total+'</td>').appendTo(row);
                $('<td class="w3-center text-danger"><a href="#" onclick="eliminarDetalleVenta('+it.productoId+','+it.cartillaDiariaId+','+it.detalleCartillaDiariaId+')"><i class="fa fa-times"></i></a></td>').appendTo(row);
	            $('#tablaDetalleVenta > tbody:last').append(row);
            });
        } else {
            let row = $('<tr></tr>');
            $('<td class="w3-center" colspan="5">Sin detalles</td>').appendTo(row);
            $('<td class="w3-right-align custom-bolder" colspan="3">'+UtilNumeros.roundMoney(total)+'</td>').appendTo(row);
        }
	    if(dataReq.detalleVentaCompuesto && dataReq.detalleVentaCompuesto.length > 0) {
	        dataReq.detalleVentaCompuesto.forEach(it => {
	            total += it.totalVenta;
                let row = $('<tr></tr>');
                $('<td>'+it.nombre+'</td>').appendTo(row);
                $('<td class="w3-center">'+it.cantidadVenta+'</td>').appendTo(row);
                $('<td class="w3-center">'+it.xtipoVenta+'</td>').appendTo(row);
                $('<td class="w3-center">'+it.precioVenta+'</td>').appendTo(row);
                $('<td class="w3-center">'+it.totalVenta+'</td>').appendTo(row);
                $('<td class="w3-center text-danger"><a href="#" onclick="eliminarDetalleVentaCompuesto('+it.id+')"><i class="fa fa-times"></i></a></td>').appendTo(row);
                $('#tablaDetalleVenta > tbody:last').append(row);
            })
        }
        let row = $('<tr></tr>');
        $('<td colspan="3" style="padding-top: 50px">SON: '+numeroALetras(total)+'</td>').appendTo(row);
        $('<td class="w3-right-align custom-bolder" colspan="3" style="padding-top: 50px">'+UtilNumeros.roundMoney(total)+'</td>').appendTo(row);
        $('#tablaDetalleVenta > tfoot').append(row);
    }
    function btnAdicionarCompuesto(id){
        $('#formularioCompuesto').data('formValidation').resetForm();
        $('#formularioCompuesto')[0].reset();
        $('#cantidadCompuesto').val('')
        $('#contenidoCartilla').html('');
        let existeDetalleVenta = dataReq.detalleVentaCompuesto.find(it => it.id === id);
        dataReq.detalleAux = null;
        if(existeDetalleVenta) {
            $('#cantidadCompuesto').val(existeDetalleVenta.cantidadVenta);
            dataReq.detalleAux = existeDetalleVenta;
        } else {
            dataReq.cartillaDiariaList.cartillaSucursalFormList.forEach(det => {
                if(det.id === id) {
                    dataReq.detalleAux = det
                }
            });
        }
        if(dataReq.detalleAux) {
            let row = $('<div class="row"></div>');
            $('<div class="col-md-6"><span class="custom-bolder h4">'+ dataReq.detalleAux.nombre +'</span> <span class="custom-bolder h5 text-muted">Bs. '+ dataReq.detalleAux.total +'</span></div>').appendTo(row);
            $('<div class="col-md-2 custom-bolder">Cantidad</div>').appendTo(row);
            $('<div class="col-md-4 custom-bolder text-center">Acciones</div>').appendTo(row);
            dataReq.detalleAux.detalleCartillaList.forEach(subdet => {
                $('<div class="col-md-12 custom-bolder padding-left-lg">'+ subdet.xtipoProducto +'</div>').appendTo(row);
                if(subdet.productos && subdet.productos.length > 0) {
                    subdet.productos.forEach(item => {
                        if(!item.cantidadVenta) {
                            item.cantidadVenta = 0;
                        }
                        $('<div class="col-md-6 padding-left-xl margin-top-lg">' + item.xproducto + '</div>').appendTo(row);
                        $('<div class="col-md-2 margin-top-lg"><input type="text" size="8" disabled class="w3-tiny" id="detalleCantidadCompuesta-'+item.id+'" name="detalleCantidadCompuesta" value="'+item.cantidadVenta+'" /></div>').appendTo(row);
                        $('<div class="col-md-4 margin-top-lg text-center"><button class="btn btn-xs btn-danger" style="margin-right: 15px;" onclick="disminuirSubdetalle('+item.cartillaDiariaId+','+item.cartillaSucursalId+','+item.id+')" type="button"><i class="fa fa-minus"></i></button><button class="btn btn-xs btn-success" onclick="aumentarSubdetalle('+item.cartillaDiariaId+','+item.cartillaSucursalId+','+item.id+')" type="button"><i class="fa fa-plus"></i></button></div>').appendTo(row);
                    })
                } else {
                    $('<div class="text-center">Sin detalles</div>')
                }
            });
            $('<div class="col-md-12"><hr/></div>').appendTo(row);
            $('#contenidoCartilla').append(row);
        }
        $('#modalCompuesto').modal('show');
    }
    function disminuirSubdetalle(cartillaDiariaId,cartillaSucursalId,detalleCartillaId){
        dataReq.detalleAux.detalleCartillaList.forEach(subdet => {
            subdet.productos.forEach(item => {
                if(item.cartillaDiariaId === cartillaDiariaId && item.cartillaSucursalId === cartillaSucursalId
                && item.id === detalleCartillaId) {
                    if(!item.cantidadVenta) {
                        item.cantidadVenta = 0;
                    }
                    // Verificar quno sobre pase el stock disponible
                    if(item.cantidadVenta <=0) {
                        $('#detalleCantidadCompuesta-'+detalleCartillaId).val(item.cantidadVenta);
                        return;
                    }
                    item.cantidadVenta--;
                    $('#detalleCantidadCompuesta-'+detalleCartillaId).val(item.cantidadVenta);
                }
            })
        })
    }
    function aumentarSubdetalle(cartillaDiariaId,cartillaSucursalId,detalleCartillaId){
        dataReq.detalleAux.detalleCartillaList.forEach(subdet => {
            subdet.productos.forEach(item => {
                if(item.cartillaDiariaId === cartillaDiariaId && item.cartillaSucursalId === cartillaSucursalId
                    && item.id === detalleCartillaId) {
                    if(!item.cantidadVenta) {
                        item.cantidadVenta = 0;
                    }
                    // Verificar quno sobre pase el stock disponible
                    if(item.cantidadVenta >= item.cantidad) {
                        modalAlert('Cantidad limite', 'No se puede cuenta con mas unidades del producto.','error');
                        return;
                    }
                    item.cantidadVenta++;
                    $('#detalleCantidadCompuesta-'+detalleCartillaId).val(item.cantidadVenta);
                }
            })
        })
    }
    function seleccionarMesa(id){
        let mesaSelected = dataReq.mesaList.find(it => it.id === id);
        dataReq.venta.mesa = mesaSelected;
    }
	function init(){
	    $('#areaMesa').html('');
        $('#areaProducto').html('');
	    $.post('../venta/initParam', function(resp){
	        if(resp.status) {
                dataReq.venta.cliente = resp.data.cliente;
	            dataReq.mesaList = resp.data.mesas;
	            dataReq.productoList = resp.data.productos;
	            dataReq.cartillaDiariaList = resp.data.cartillaDiariaList;
	            if(resp.data.mesas && resp.data.mesas.length > 0) {
	                resp.data.mesas.forEach(it => {
	                    let divCol = $('<div class="col-md-2"></div>');
	                    let divInfoBox = $('<div class="info-box"></div>');
	                    $('<span class="info-box-icon bg-aqua"><input type="radio" class="w3-radio" onchange="seleccionarMesa('+it.id+')" name="mesaId" value="'+it.id+'"/></span>').appendTo(divInfoBox);
	                    let divContent = $('<div class="info-box-content"></div>');
	                    $('<span class="info-box-number">'+it.alias+'</span>').appendTo(divContent);
                        $('<span class="info-box-text">'+it.nombre+'</span>').appendTo(divContent);
                        $('<span class="info-box-more">Cantidad: '+it.cantidad+' </span>').appendTo(divContent);
                        divInfoBox.append(divContent);
                        divCol.append(divInfoBox);
                        $('#areaMesa').append(divCol);
                    })
                }
	            if(resp.data.productos && resp.data.productos.length > 0) {
	                resp.data.productos.forEach(it => {
	                    let div1 = $('<div class="col-md-4 item" id="areaProducto-'+it.productoId+'"></div>');
	                    if(imageExists('/producto/'+it.foto)) {
                            $('<div class="plato-img"><img src="/producto/'+it.foto+'" alt="Product Image"></div>').appendTo(div1);
                        } else {
                            $('<div class="plato-img"><img src="/producto/notimage.png" alt="Product Image"></div>').appendTo(div1);
                        }
	                    let div2 = $('<div class="plato-info"></div>');
	                    $('<a href="#" class="plato-title">Bs. <span id="precio-'+it.productoId+'">'+it.pvUnit+'</span> <span class="label label-warning pull-right w3-small" id="cant-'+it.productoId+'">Stock: '+it.cantidad+'</span></a>').appendTo(div2);
	                    $('<span class="plato-description">'+it.xproducto+'</span>').appendTo(div2);
	                    div1.append(div2);
	                    let div3 = $('<span class="plato-description"></span>');
                        $('<input type="text" class="w3-medium" style="width: 50%;" id="cantidad-'+it.productoId+'" name="can"/><input type="hidden" name="productoId" value="'+it.productoId+'"/>').appendTo(div3);
                        $('<button onclick="btnMinProducto('+it.productoId+')" class="btn btn-xs btn-danger" style="margin-left: 10px;margin-right: 5px;"><span class="fa fa-minus"></span></button>').appendTo(div3);
                        $('<button onclick="btnMaxProducto('+it.productoId+')" class="btn btn-xs btn-success" style="margin-left: 5px;margin-right: 10px;"><span class="fa fa-plus"></span></button>').appendTo(div3);
                        let div4 = $('<span class="plato-description"></span>');
                        let div5 = $('<div class="radio"></div>');
                        $('<label style="margin-right: 10px;"><input type="radio" onchange="radioTipoVentaProducto('+it.productoId+',1)" name="tipoVenta-'+it.productoId+'" value="1" checked> Unidad </label>').appendTo(div5);
                        $('<label><input type="radio" onchange="radioTipoVentaProducto('+it.productoId+',2)" name="tipoVenta-'+it.productoId+'" value="2" > Caja</label>').appendTo(div5);
                        $('<span class="pull-right"><button onclick="btnAdicionarProducto('+it.productoId+')" class="btn btn-xs btn-primary">OK</button></span>').appendTo(div5);
                        div4.append(div5);
                        div1.append(div3);
                        div1.append(div4);
                        $('#areaProducto').append(div1);
                    });
                }
	            if(resp.data.cartillaDiariaList) {
                    let auxCartilla = resp.data.cartillaDiariaList.cartillaSucursalFormList;
                    auxCartilla.forEach(it => {
                        $('#tabCartilla').append($('<li><a href="#tab_'+it.id+'" data-toggle="tab">'+it.nombre+'</a></li>'));
                        let divContent = $('<div class="tab-pane" id="tab_'+it.id+'"></div>');
                        if(it.estaCompuesto) {
                            $('<h3>'+it.nombre+' <button class="btn btn-success" type="button" onclick="btnAdicionarCompuesto('+it.id+')"> <i class="fa fa-plus"></i> Registrar '+it.nombre+'</button></h3>').appendTo(divContent);
                            it.detalleCartillaList.forEach(itDetalleCartilla => {
                                $('<h3>'+itDetalleCartilla.xtipoProducto+'</h3>').appendTo(divContent);
                                let divRow = $('<div class="row platos-list plato-list-in-box"></div>');
                                itDetalleCartilla.productos.forEach(itProducto => {
                                    divRow.append(generateColumnPlato(itProducto));
                                });
                                divContent.append(divRow);
                            });
                        } else {
                            let divRow = $('<div class="row platos-list plato-list-in-box"></div>');
                            it.detalleCartillaList[0].productos.forEach(itProducto => {
                                divRow.append(generateColumnPlato(itProducto));
                            });
                            divContent.append(divRow);
                        }
                        $('#tabContentCartilla').append(divContent);
                    })
                } else {
	                modalAlert('Sin cartilla de preparaciones', 'Contactarse con administracion', 'info');
                }
            }
        })
    }
    function generateColumnPlato(itProducto){
        let div1 = $('<div class="col-md-4 item" id="areaPlato-'+itProducto.cartillaDiariaId+'-'+itProducto.id+'"></div>');
        if(imageExists('/producto/'+itProducto.foto)) {
            $('<div class="plato-img"><img src="/producto/'+itProducto.foto+'" alt="Product Image"></div>').appendTo(div1);
        } else {
            $('<div class="plato-img"><img src="/producto/notimage.png" alt="Product Image"></div>').appendTo(div1);
        }
        let div2 = $('<div class="plato-info"></div>');
        $('<a href="#" class="plato-title">Bs. <span id="precioPlato-'+itProducto.id+'">'+itProducto.precioIndividual+'</span> <span class="label label-warning pull-right w3-small" id="cantPlato-'+itProducto.id+'">Stock: '+itProducto.cantidad+'</span></a>').appendTo(div2);
        $('<span class="plato-description">'+itProducto.xproducto+'</span>').appendTo(div2);
        div1.append(div2);
        let div3 = $('<span class="plato-description"></span>');
        $('<input type="text" class="w3-medium" style="width: 50%;" id="cantidadPlato-'+itProducto.id+'" name="can"/>').appendTo(div3);
        $('<button onclick="btnMinPlato('+itProducto.id+')" class="btn btn-xs btn-danger" style="margin-left: 10px;margin-right: 5px;"><span class="fa fa-minus"></span></button>').appendTo(div3);
        $('<button onclick="btnMaxPlato('+itProducto.id+')" class="btn btn-xs btn-success" style="margin-left: 5px;margin-right: 10px;"><span class="fa fa-plus"></span></button>').appendTo(div3);
        let div4 = $('<span class="plato-description"></span>');
        $('<span class="pull-right"><button onclick="btnAdicionarPlato('+itProducto.cartillaSucursalId+','+itProducto.cartillaDiariaId+','+itProducto.detalleCartillaSucursalId+','+itProducto.id+','+itProducto.productoId+')" class="btn btn-xs btn-primary">OK</button></span>').appendTo(div4);
        div1.append(div3);
        div1.append(div4);
        return div1;
    }
    function adicionarObservacion(productoId, cartillaDiariaId, detalleCartillaDiariaId){
        let xproducto = '';
        if(cartillaDiariaId && detalleCartillaDiariaId) {
            dataReq.detalleVenta.forEach(it => {
                if(it.cartillaDiariaId === cartillaDiariaId && it.detalleCartillaDiariaId === detalleCartillaDiariaId) {
                    xproducto = it.xproducto;
                }
            })
        } else {
            dataReq.detalleVenta.forEach(it => {
                if(it.productoId === productoId) {
                    xproducto = it.xproducto;
                }
            })
        }
        let obs = $('#obsGeneral').val();
        if(obs) {
            obs = obs.trim()+'\n';
        } else {
            obs = '';
        }
        obs += xproducto + '.- ';
        $('#obsGeneral').val(obs);
        $('#obsGeneral').focus();
    }
    function adicionarObservacionCompuesto(id){
        let xproducto = '';
        dataReq.detalleVentaCompuesto.forEach(it => {
            if(it.id === id) {
                xproducto = it.nombre;
            }
        })
        let obs = $('#obsGeneral').val();
        if(obs) {
            obs = obs.trim()+'\n';
        } else {
            obs = '';
        }
        obs += xproducto + '.- ';
        $('#obsGeneral').val(obs);
        $('#obsGeneral').focus();
    }
    function calcularTotal(){
        if(!dataReq.venta.descuento) {
            dataReq.venta.descuento = 0;
        }
        dataReq.venta.total = dataReq.venta.subtotal - dataReq.venta.descuento;
        dataReq.venta.totalLiteral = 'Son: '+numeroALetras(dataReq.venta.total);
        if(!dataReq.venta.totalPagado) {
            dataReq.venta.totalPagado = 0;
        }
        dataReq.venta.totalCambio = dataReq.venta.totalPagado - dataReq.venta.total;
    }
    function setDescuento(){
        setTimeout(function(){
            let descuento = $('#descuentoVenta').val();
            if(!descuento) {
                descuento = 0;
            } else {
                descuento = parseFloat(descuento);
            }
            dataReq.venta.descuento = descuento;
            calcularTotal()
            $('#formulario4').loadJSON(dataReq.venta);
        },250);
    }
    function setTotalPagado(){
        setTimeout(function(){
            let totalPagado = $('#totalPagado').val();
            if(!totalPagado) {
                totalPagado = 0;
            } else {
                totalPagado = parseFloat(totalPagado);
            }
            dataReq.venta.totalPagado = totalPagado;
            calcularTotal();
            $('#formulario4').loadJSON(dataReq.venta);
        },250);
    }
    $(document).ready(function() {
        // Toolbar extra buttons
        const btnCancel = $('<button></button>').html('<i class="fa fa-times-circle"></i><br/>Salir Venta')
            .addClass('btn w3-red w3-border-red')
            .on('click', function(){
                alertCancelacion('Cancelar venta', 'Esta seguro de cancelar la venta', function () {
                    $.post('../venta/gestion', function (resp) {
                        $("#contenedor").html(resp);
                    });
                })
            });
        // Step show event
        $("#smartwizard").on("showStep", function(e, anchorObject, stepNumber, stepDirection, stepPosition) {
            $("#prev-btn").removeClass('disabled');
            $("#next-btn").removeClass('disabled');
            if(stepPosition === 'first') {
                $("#prev-btn").addClass('disabled');
            } else if(stepPosition === 'last') {
                $("#next-btn").addClass('disabled');
            } else {
                $("#prev-btn").removeClass('disabled');
                $("#next-btn").removeClass('disabled');
            }
        });

        // Smart Wizard
        $('#smartwizard').smartWizard({
            selected: 0,
            theme: 'arrows', // default, arrows, dots, progress
            //darkMode: true,
            transition: {
                animation: 'slide-horizontal', // Effect on navigation, none/fade/slide-horizontal/slide-vertical/slide-swing
            },
            toolbarSettings: {
                toolbarPosition: 'bottom', // both bottom
                toolbarExtraButtons: [btnCancel],
                toolbarButtonPosition: 'center'
            },
            lang: {
                next: 'Siguiente',
                previous: 'Volver atras'
            }
        });

        // External Button Events
        $("#reset-btn").on("click", function() {
            $('#smartwizard').smartWizard("reset");
            return true;
        });

        $("#prev-btn").on("click", function() {
            $('#smartwizard').smartWizard("prev");
            return true;
        });

        $("#next-btn").on("click", function() {
            $('#smartwizard').smartWizard("next");
            return true;
        });
        $('.sw-btn-next').html('<i class="fa fa-arrow-circle-right"></i><br>Siguiente');
        $('.sw-btn-prev').html('<i class="fa fa-arrow-circle-left"></i><br>Volver atras');
        $('#smartwizard').smartWizard("goToStep", 0);
        $("#smartwizard").on("stepContent", function(e, anchorObject, stepIndex, stepDirection) {
            if(stepIndex === 2) {
                //Renderizar resumen de comanda
                if(dataReq.venta) {
                    $('#areaResumenVenta').loadJSON({
                        'xmesa': dataReq.venta.mesa.nombre,
                        'xcantidadPersonas': dataReq.venta.mesa.cantidad,
                        'xmesero': dataReq.venta.user.xuser,
                        'xcliente': dataReq.venta.cliente.nom_per + ' '+ dataReq.venta.cliente.priape_per + ' '+(dataReq.venta.cliente.segape_per||''),
                    });
                }
                $('#areaResumenDetalleVenta > tbody').html('');
                if(dataReq.detalleVenta && dataReq.detalleVenta.length > 0) {
                    dataReq.detalleVenta.forEach(it => {
                        let row = $('<tr></tr>');
                        $('<td>'+it.xproducto+'</td>').appendTo(row);
                        $('<td class="w3-center">'+it.cantidad+'</td>').appendTo(row);
                        $('<td class="w3-center">'+it.precio+'</td>').appendTo(row);
                        $('<td class="w3-center">'+it.total+'</td>').appendTo(row);
                        $('<td class="w3-center w3-tiny text-danger active"><a href="#" onclick="adicionarObservacion('+it.productoId+','+it.cartillaDiariaId+','+it.detalleCartillaDiariaId+')">Agregar Observacion</a></td>').appendTo(row);
                        $('#areaResumenDetalleVenta > tbody:last').append(row);
                    });
                }
                if(dataReq.detalleVentaCompuesto && dataReq.detalleVentaCompuesto.length > 0) {
                    dataReq.detalleVentaCompuesto.forEach(it => {
                        let row = $('<tr></tr>');
                        $('<td>'+it.nombre+'</td>').appendTo(row);
                        $('<td class="w3-center">'+it.cantidadVenta+'</td>').appendTo(row);
                        $('<td class="w3-center">'+it.precioVenta+'</td>').appendTo(row);
                        $('<td class="w3-center">'+it.totalVenta+'</td>').appendTo(row);
                        $('<td class="w3-center w3-tiny text-danger active"><a href="#" onclick="adicionarObservacionCompuesto('+it.id+')">Agregar Observacion</a></td>').appendTo(row);
                        $('#areaResumenDetalleVenta > tbody:last').append(row);
                    });
                }
            }
            if(stepIndex === 3) {
                let obsGeneral = $('#obsGeneral').val();
                if(!obsGeneral) {
                    obsGeneral = '';
                }
                dataReq.venta.obs = obsGeneral;
                let totalVenta = 0;
                $('#areaDetalleInfo > tbody').html('');
                if(dataReq.detalleVenta && dataReq.detalleVenta.length > 0) {
                    dataReq.detalleVenta.forEach(it => {
                        let row = $('<tr></tr>');
                        $('<td>'+it.xproducto+'</td>').appendTo(row);
                        $('<td class="w3-center">'+it.cantidad+'</td>').appendTo(row);
                        $('<td class="w3-center">'+it.precio+'</td>').appendTo(row);
                        $('<td class="w3-center">'+it.total+'</td>').appendTo(row);
                        $('#areaDetalleInfo > tbody:last').append(row);
                        totalVenta += it.total;
                    });
                }
                if(dataReq.detalleVentaCompuesto && dataReq.detalleVentaCompuesto.length > 0) {
                    dataReq.detalleVentaCompuesto.forEach(it => {
                        let row = $('<tr></tr>');
                        $('<td>'+it.nombre+'</td>').appendTo(row);
                        $('<td class="w3-center">'+it.cantidadVenta+'</td>').appendTo(row);
                        $('<td class="w3-center">'+it.precioVenta+'</td>').appendTo(row);
                        $('<td class="w3-center">'+it.totalVenta+'</td>').appendTo(row);
                        $('#areaDetalleInfo > tbody:last').append(row);
                        totalVenta += it.totalVenta;
                    });
                }
                dataReq.venta.subtotal = totalVenta;
                calcularTotal();
                $('#formulario4').loadJSON(dataReq.venta);
            }
        });
        $('#formulario3').formValidation({
            locale: 'es_ES'
        }).on('success.fv.field', '[name="desVen"]', function() {
        	calculoTotal();
        }).on('success.fv.field', '[name="descuentos"]', function() {
            calculoTotal();
        }).on('success.fv.field', function() {
            var estadoForm3 = $('#formulario3').data('formValidation').isValid();
            if (estadoForm3) {
                calculoTotal();
            }
        }).on('err.field.fv', function(e) {
            e.preventDefault();
            var xform = $(e.target);
            $('#total-final').html('');
        }).on('success.form.fv', function(e) {
            e.preventDefault();
            let xform = $(e.target);
            let formapago = parseInt($('input[name=formapago]:checked').val());
            if(formapago == 1){
            	let codSubcuenta = $('#codSubcuenta option:selected').val();
            	if(codSubcuenta == ''){
            		modalAlert('Validacion incorrecta', 'Seleccione una cuenta bancaria, si la forma de pago es por deposito bancario','error');
            		return;
            	}
            }
            alertAdicion('Confirmacion de registro de venta', 'Esta seguro de realizar esta venta?', function(){
            	$('#formulario1').data('formValidation').validate();
                var estadoForm1 = $('#formulario1').data('formValidation').isValid();
                if ($('#total').val() > 0) {
                    if (estadoForm1 != null)
                        if (estadoForm1) {
                            try {
                                abrirLoad();
                                $.post(xform.attr('action'), $('#formulario1').serialize() + '&' + $('#formulario4').serialize() + '&' + xform.serialize(), function(result) {
                                    cerrarLoad();
                                    if (result.status) {
                                        xform.data('formValidation').resetForm();
                                        $.post('../venta/gestion', function(respuno) {
                                            mostrarMensaje('info', 'Se realizo con exito la Transaccion.');
                                            $('#contenedor').html(respuno);
                                        });
                                    } else {
                                        mostrarMensaje('error', 'No se realizo con exito la transaccion.');
                                    }
                                }, 'json');
                            } catch (e) {
                                console.log('Error al adicionar venta: ',e);
                                cerrarLoad();
                            } finally {
                                cerrarLoad();
                            }
                        }
                } else {
                    $('#formulario1').data('formValidation').validate();
                    mostrarMensaje('error', 'Valide los campos requeridos.');
                    mostrarMensaje('error', 'Por favor ingrese el detalle.');
                }
            });
        });
        $('#adicionarCliente').click(function() {
            $('#formularioCliente').data('formValidation').resetForm();
            $('#formularioCliente')[0].reset();
            $('#codigo').val(0);
            $('#modalCliente').modal('show');
        });
        $('#formularioCliente').formValidation({
            locale: 'es_ES'
        }).on('success.form.fv', function(e) {
            e.preventDefault();
            var xform = $(e.target);
            alertAdicion('Registro de cliente', 'Esta seguro de registrar este cliente?', function(){
            	$.post(xform.attr('action'), xform.serialize(), function(result) {
                    if (result.status) {
                        xform.data('formValidation').resetForm();
                        dataReq.venta.cliente = result.xcliente;
                        $('#xcliente').html(result.cliente);
                        $('.modal').modal('hide');
                        mostrarMensaje('info', 'Se realizo con exito la Transaccion');
                    } else {
                        mostrarMensaje('error', 'No se realizo con exito la Transaccion');
                    }
                }, 'json');
            })
        });
        $('#formularioCompuesto').formValidation({
            locale: 'es_ES'
        }).on('success.form.fv', function(e) {
            e.preventDefault();
            let statusModal = true;
            let cantidad = parseInt($('#cantidadCompuesto').val());
            if(cantidad <= 0) {
                modalAlert('Ingrese una cantidad correcta', 'La cantidad no es correcta', 'info');
                statusModal = false;
                return;
            }
            dataReq.detalleAux.detalleCartillaList.forEach(subdet => {
                let cantidadTipo = 0;
                subdet.productos.forEach(item => {
                    if(item.cantidadVenta && item.cantidadVenta > 0) {
                        cantidadTipo += item.cantidadVenta;
                    }
                })
                if(cantidadTipo !== cantidad) {
                    if(cantidadTipo > cantidad) {
                        modalAlert(subdet.xtipoProducto, 'La cantidad excede a lo solicitado', 'error');
                        $('#btnSubmitSubdetalle').removeClass('disabled').removeAttr('disabled');
                        statusModal = false;
                        return;
                    }
                    if(cantidadTipo < cantidad) {
                        modalAlert(subdet.xtipoProducto, 'La cantidad es menor a lo solicitado', 'error');
                        $('#btnSubmitSubdetalle').removeClass('disabled').removeAttr('disabled');
                        statusModal = false;
                        return;
                    }
                }
            });
            if(statusModal) {
                //Si todo esta bien, se procede al resguardo
                dataReq.detalleAux.cantidadVenta = cantidad;
                dataReq.detalleAux.precioVenta = dataReq.detalleAux.total;
                dataReq.detalleAux.totalVenta = cantidad * dataReq.detalleAux.total;
                dataReq.detalleAux.tipoVenta = 1;//unidad
                dataReq.detalleAux.xtipoVenta = 'Unid.';//unidad
                let existeDetalle = false;
                dataReq.detalleVentaCompuesto.forEach(it => {
                    if(it.id === dataReq.detalleAux.id) {
                        it = dataReq.detalleAux;
                        existeDetalle = true;
                    }
                })
                if(!existeDetalle) {
                    dataReq.detalleVentaCompuesto.push(dataReq.detalleAux);
                }
                $('#modalCompuesto').modal('hide');
                renderDetalleVenta();
            }

        });
        $('#usuarioId').change(function(){
            let user = $('#usuarioId option:selected').val();
            let xuser = $('#usuarioId option:selected').html();
            dataReq.venta.user = {'userId':user,'xuser':xuser};
        });
        var tableCliente = $('#tablaCliente').DataTable({
            buttons: [],
            "ajax": {
                "type": "POST",
                "url": "../cliente/listar",
                "data": function(d) {
                    d.estado = $('input[name=estado]:checked').val();
                }
            },
            "ordering": true,
            "order": [[0,'desc']],
            "columnDefs": [{targets:[3], className:'text-right'}],
            "columns": [{
                "data": "cod_cli"
            }, {
                "data": "tel_per"
            }, {
                "data": "cod_cli"
            }, {
                "data": "cod_cli"
            }],
            "createdRow": function(row, data, index) {
                $('td', row).eq(1).html(data.nom_per + ' ' + data.priape_per + ' ' + data.segape_per);
                $('td', row).eq(3).html('<a href="#" class="seleccionarCliente"> &laquo; Seleccionar &raquo; </a>');
            },
            "drawCallback": function(settings) {
                $('.seleccionarCliente').click(function() {
                    let obj = tableCliente.row($(this).closest('tr')).data();
                    dataReq.venta.cliente = obj;
                    $('#xcliente').html(obj.nom_per + ' ' + obj.priape_per + ' ' + obj.segape_per||'');
                    $('#modalGestionCliente').modal('hide');
                });
            }
            ,"initComplete": function(settings, json) {
                $('#tablaCliente_filter input').unbind();
                $('#tablaCliente_filter input').bind('keyup', function(e) {
                    if ( e.keyCode == 13) {
                        $('#tablaCliente').DataTable().search(this.value).draw();
                    }
                })
            }
        });
        $('#btnCliente').click(function(){
            $('#modalGestionCliente').modal('show');
        })
        init();
    });
</script>
</section>